<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sampling design for monitoring boreal birds in Quebec - 8&nbsp; A guide for BMS sampling design with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ecosumm_habitat.html" rel="next">
<link href="./SSU.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./runGRTSexample.html">Appendices</a></li><li class="breadcrumb-item"><a href="./runGRTSexample.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">A guide for BMS sampling design with R</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Sampling design for monitoring boreal birds in Quebec</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/willvieira/sampling_BMS/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./Sampling-design-for-monitoring-boreal-birds-in-Quebec.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
    <a href="https://twitter.com/intent/tweet?url=|url|" title="Twitter" class="quarto-navigation-tool px-1" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./studyArea.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Sampling frame</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">PSU inclusion probability</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./habitat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Habitat information</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cost information</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./legacy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Legacy and iconic sites</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Sampling design</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PSU.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Primary sampling unity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SSU.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Secondary sampling unity</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./runGRTSexample.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">A guide for BMS sampling design with R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ecosumm_habitat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Ecoregion summary: habitat</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ecosumm_cost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Ecoregion summary: cost</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ecosumm_legacySites.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Ecoregion summary: historical sites</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ecosumm_selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Ecoregion summary: selected hexagons</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#custom-parameters" id="toc-custom-parameters" class="nav-link" data-scroll-target="#custom-parameters">Custom parameters</a></li>
  <li><a href="#prepare-layers-for-sampling" id="toc-prepare-layers-for-sampling" class="nav-link" data-scroll-target="#prepare-layers-for-sampling">Prepare layers for sampling</a></li>
  <li><a href="#adjust-sample-size-and-inclusion-probability-as-a-function-of-legacy-sites" id="toc-adjust-sample-size-and-inclusion-probability-as-a-function-of-legacy-sites" class="nav-link" data-scroll-target="#adjust-sample-size-and-inclusion-probability-as-a-function-of-legacy-sites">Adjust sample size and inclusion probability as a function of legacy sites</a></li>
  <li><a href="#primary-sampling-unit-psu" id="toc-primary-sampling-unit-psu" class="nav-link" data-scroll-target="#primary-sampling-unit-psu">Primary Sampling Unit (PSU)</a></li>
  <li><a href="#secondary-sampling-unit-ssu" id="toc-secondary-sampling-unit-ssu" class="nav-link" data-scroll-target="#secondary-sampling-unit-ssu">Secondary Sampling Unit (SSU)</a></li>
  <li><a href="#export-psu-and-ssu-samples-in-shapefiles" id="toc-export-psu-and-ssu-samples-in-shapefiles" class="nav-link" data-scroll-target="#export-psu-and-ssu-samples-in-shapefiles">Export PSU and SSU samples in shapefiles</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/willvieira/sampling_BMS/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">A guide for BMS sampling design with R</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>In this section, we will provide an overview and explanation of the code used for the final step of the BMS sampling design. This report is designed to be self-contained and provides all the necessary steps for processing the data layers in conjunction with the GRTS algorithm to perform the sampling. The complete procedure, including code for data preparation and analysis, is organized in sequential R scripts and can be found in the <a href="https://github.com/willvieira/sampling_BMS/">GitHub repository</a>. This specific report refers to the R script <a href="https://github.com/willvieira/sampling_BMS/blob/main/08_runGRTS.R"><code>08_runGRTS.R</code></a>.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Bellow we list the packages used in the sampling process. Note that the code described in the report is only compatible with spsurvey R package versions v5.0 and above. For consistent results, we recommend loading the same environment that was used in this project, which is saved in the <code>renv.lock</code> file. The following steps can be used to load the same environment:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install `renv` package if necessary</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(renv)) <span class="fu">install.packages</span>(<span class="st">'renv'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Restore the project environment</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">activate</span>(<span class="at">project =</span> <span class="st">"/path/to/project"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The first line of code will check load (and install if necessary) the R pacakge <code>renv</code> to manage the version of the dependences. The <code>activate()</code> function will install all necessary packages with their respective version into a local container accessible only by this project. If you’re not already in the path of the project, make sure to replace <code>/path/to/project</code> with the path to the directory where the project is stored.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatstat)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spsurvey)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MBHdesign)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># to reproduce the same results</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="fl">0.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="custom-parameters" class="level2">
<h2 class="anchored" data-anchor-id="custom-parameters">Custom parameters</h2>
<p>Here is the main section the user will need to interact. Below is a list of all the variables that can be used to customize the sampling process, each accompanied by detailed comments.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold to determine whether a hexagon is suitable for sampling is based on</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the proportion of NA pixels (non-natural habitat).</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `0.8` means a hexagon has to have at least 20% of habitat pixels to be</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># suitable for sampling</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>prop_na <span class="ot">=</span> <span class="fl">0.8</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample effort in percentage</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>sample_effort <span class="ot">=</span> <span class="fl">0.02</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Total sample size for SSU within a hexagon (Main + Over)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># It must be an even numbers</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>ssu_N <span class="ot">=</span> <span class="dv">6</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of replications when selecting the PSU with the GRTS algorithm</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>nb_rep <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Code of ecoregions to sample</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>eco_sim <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'7'</span>, <span class="st">'28'</span>, <span class="st">'30'</span>, <span class="st">'31'</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46'</span>, <span class="st">'47'</span>, <span class="st">'48'</span>, <span class="st">'49'</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'73'</span>, <span class="st">'77'</span>, <span class="st">'78'</span>, <span class="st">'86'</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'72'</span>, <span class="st">'74'</span>, <span class="st">'75'</span>, <span class="st">'76'</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'96'</span>, <span class="st">'99'</span>, <span class="st">'100'</span>, <span class="st">'101'</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'102'</span>, <span class="st">'103'</span>, <span class="st">'117'</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'216'</span>, <span class="st">'217'</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># File path of the csv file used to store the legacy sites</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># E.g. https://github.com/willvieira/sampling_BMS/blob/main/data/legacySites.csv</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># `lat` and `lon` arguments are used to define the character name of the</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co"># columns in the csv</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>and columns to extract legacy sites</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>legacyFile <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'legacySites.csv'</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>lat <span class="ot">=</span> <span class="st">'latitude'</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>lon <span class="ot">=</span> <span class="st">'longitude'</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Buffer size (in Km) to adjust inclusion probability of hexagons around the</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co"># legacy sites using the MBHdesign R package</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>bufferSize_p <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Buffer size (in Km) to adjust the sample size of an ecoregion as a function of</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co"># the number and distribution of its legacy sites</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co"># The value provided can either be a single number applied to all ecoregions or</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co"># a file path containing the buffer size information for each ecoregion.</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="co"># E.g.https://github.com/willvieira/sampling_BMS/blob/main/data/bufferSize_N.csv</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>bufferSize_N <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'bufferSize_N.csv'</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to assign the same buffer size (in Km) for all ecoregion:</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co"># bufferSize_N = 15</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance between SSU centroid (in meters)</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>ssu_dist <span class="ot">=</span> <span class="dv">294</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to save the shapefiles with the selected PSU and SSU</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>outputFolder <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">'output'</span>, <span class="st">'selection2023'</span>)</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="co"># suffix to add for each output layer</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g.: PSU-SOQB_ALL-SUFFIX.shp</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>fileSuffix <span class="ot">=</span> <span class="st">'V2023'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="prepare-layers-for-sampling" class="level2">
<h2 class="anchored" data-anchor-id="prepare-layers-for-sampling">Prepare layers for sampling</h2>
<p>The first step is loading the complete hexagons list within the study area. While loading, we keep only the hexagons for the ecoregions of interest (<code>eco_sim</code>) and remove the hexagons with too many NA habitats. We then compute the hexagon inclusion probability from the habitat and cost layers normalized for the study area.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>hexas <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'hexa_complete.RDS'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(propNA <span class="sc">&lt;=</span> prop_na) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ecoregion <span class="sc">%in%</span> eco_sim) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">p =</span> (hab_prob <span class="sc">*</span> cost_prob) <span class="sc">/</span> <span class="fu">sum</span>(hab_prob <span class="sc">*</span> cost_prob)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(p <span class="sc">!=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The legacy sites are the second layer of information needed to run the GRTS. Bellow the code is written to load the list of coordinate points from the legacy sites and create a data frame describing the count number of legacy sites per hexagon. This procedure scales the point data to the hexagon level, allowing us to modify the inclusion probability of the neighboring hexagons and adjust the ecoregion sample size.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to transform Latitude &amp; longitude legacy site points in a table</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with the number of points per hexagon ID (ET_Index)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>import_legacySites <span class="ot">&lt;-</span> <span class="cf">function</span>(File, lat_name, lon_name)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># transform hexagons projection to the same of the legacy points</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    hx <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># read legacy csv file</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    lg <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(File, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">lat =</span> <span class="fu">all_of</span>(lat_name),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">lon =</span> <span class="fu">all_of</span>(lon_name)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_sf</span>(</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">'lon'</span>, <span class="st">'lat'</span>),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">crs =</span> <span class="fu">st_crs</span>(hx)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intersect legacy points with hexagon polygons</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    nbLegacy <span class="ot">&lt;-</span> hx <span class="sc">|&gt;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_contains</span>(lg, <span class="at">sparse =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">apply</span>(<span class="dv">1</span>, sum)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return a transformed data to data.frame</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and keep only the hexagons that contains legacy sites</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">ET_Index =</span> hx<span class="sc">$</span>ET_Index,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">nbLegacySites =</span> nbLegacy</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(nbLegacySites <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co"># load and transform legacy sites (slow function)</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>legacySites <span class="ot">&lt;-</span> <span class="fu">import_legacySites</span>(</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">File =</span> legacyFile,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_name =</span> lat,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_name =</span> lon</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co"># merge legacy sites data.frame into hexagon object</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>hexas <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(legacySites) <span class="sc">|&gt;</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nbLegacySites =</span> <span class="fu">replace_na</span>(nbLegacySites, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="adjust-sample-size-and-inclusion-probability-as-a-function-of-legacy-sites" class="level2">
<h2 class="anchored" data-anchor-id="adjust-sample-size-and-inclusion-probability-as-a-function-of-legacy-sites">Adjust sample size and inclusion probability as a function of legacy sites</h2>
<p>After merging the hexagons and legacy sites, the next step is to adjust the sample size and modify the inclusion probabilities. The sample size, defined in the number of hexagons, is defined in function of the size of the ecoregion, the sampling effort (<code>sample_effort</code>), and the number of legacy sites. The input <code>bufferSize_N</code> quantify the effect of each legacy site in reducing the final sample size. The value provided can either be a single number that will be applied to all ecoregions or a file path that contains the buffer size information for each individual ecoregion. For more details on defining the buffer size to adjust the sample size, please refer to <a href="legacy.html"><span>Chapter&nbsp;5</span></a>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to get sample size for a specific ecoregion given:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># number of hexagons, number of legacy sites, bufferSize, and sample effort</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>get_sampleSize <span class="ot">&lt;-</span> <span class="cf">function</span>(eco, hx, bf_N, sample_e)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the hexagons centroid for a specific ecoregion</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    hexa_eco <span class="ot">&lt;-</span> hx <span class="sc">|&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_centroid</span>()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(<span class="fu">subset</span>(bf_N, ecoregion <span class="sc">==</span> eco)) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create a buffer of size `BufferSize_N` around the legacy site centroid</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        hexa_legacy_bf <span class="ot">&lt;-</span> hexa_eco <span class="sc">|&gt;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(nbLegacySites <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_buffer</span>(<span class="fu">subset</span>(bf_N, ecoregion <span class="sc">==</span> eco)<span class="sc">$</span>bufferSize <span class="sc">*</span> <span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_union</span>()</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the number of hexagons from the ecoregion in which their</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># centroid falls within the buffer around the legacy sites</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        nbHexas_legacy <span class="ot">&lt;-</span> hexa_eco <span class="sc">|&gt;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_intersects</span>(hexa_legacy_bf) <span class="sc">|&gt;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">unlist</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>()</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        nbHexas_legacy <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the adjusted sample size using only the total amount of hexagons</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that do not fall within the legacy buffer</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    adj_sampleSize <span class="ot">&lt;-</span> <span class="fu">round</span>((<span class="fu">nrow</span>(hexa_eco) <span class="sc">-</span> nbHexas_legacy) <span class="sc">*</span> sample_e, <span class="dv">0</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the ecoregion is too small to accommodate 2 hexagons with the defined</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sampling effort, ensure to sample at least two hexagons.</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>((<span class="fu">nrow</span>(hexa_eco) <span class="sc">*</span> sample_e) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">&amp;</span> nbHexas_legacy <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        adj_sampleSize <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(adj_sampleSize)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load buffer size information regardless of the `byfferSize_N` class</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">is.character</span>(bufferSize_N)) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">file.exists</span>(bufferSize_N)) {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        buffSizeN <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(bufferSize_N, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">ecoregion =</span> <span class="fu">as.character</span>(ecoregion))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'File "'</span>, bufferSize_N,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'" does not exist. Please check if the name is correct.'</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.numeric</span>(bufferSize_N)){</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    buffSizeN <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">ecoregion =</span> eco_sim,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">bufferSize =</span> bufferSize_N</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">'The type of `bufferSize_N` must be either numeric or a character'</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the function to define sample size for all selected ecoregions</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>sampleSize <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(eco_sim, <span class="fu">paste0</span>(<span class="st">'eco_'</span>, eco_sim)),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    get_sampleSize,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">hx =</span> hexas,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">bf_N =</span> buffSizeN,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_e =</span> sample_effort</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stratum object with ecoregion that have</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># at least a sample size of 1</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>Stratdsgn  <span class="ot">&lt;-</span> sampleSize[sampleSize <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Because we are sampling an extra hexagon for each selected one,</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure that each ecoregion has at least 2 times more available</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># hexagons than sample N</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>eco_to_remove <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ecoregion) <span class="sc">|&gt;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">nbHexas =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        sampleSize <span class="sc">|&gt;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">ecoregion =</span> <span class="fu">as.character</span>(<span class="fu">parse_number</span>(name)),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">sampleSize_extra =</span> value <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(ecoregion, sampleSize_extra)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff =</span> nbHexas <span class="sc">-</span> sampleSize_extra</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(diff <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(ecoregion)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>Stratdsgn <span class="ot">&lt;-</span> Stratdsgn[<span class="sc">!</span><span class="fu">names</span>(Stratdsgn) <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">'eco_'</span>, eco_to_remove)]</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare sample frame to be used in GRTS</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co"># scale inclusion probability to the total sample size</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Use only the centroid of the hexagon as a sample point</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>sampleFrame <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ecoregion <span class="sc">%in%</span> <span class="fu">parse_number</span>(<span class="fu">names</span>(Stratdsgn))) <span class="sc">|&gt;</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(    </span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">eco_name =</span> <span class="fu">paste0</span>(<span class="st">'eco_'</span>, ecoregion), <span class="co"># to match design name</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">mdcaty  =</span> <span class="fu">sum</span>(Stratdsgn) <span class="sc">*</span> p<span class="sc">/</span><span class="fu">sum</span>(p),</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">geometry =</span> sf<span class="sc">::</span><span class="fu">st_geometry</span>(sf<span class="sc">::</span><span class="fu">st_centroid</span>(geometry))</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The last step involves adjusting inclusion probabilities for neighboring hexagons around legacy sites. To do this, we used the <code>MBHdesign</code> R package and adjusted the inclusion probability based on the <code>bufferSize_p</code> parameter.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Coordinates of all hexagons in matrix format for MBHdesign</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>coord_mt <span class="ot">&lt;-</span> sampleFrame <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_coordinates</span>()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Coordinates of legacy hexagons</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>legacySites <span class="ot">&lt;-</span> sampleFrame <span class="sc">|&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(nbLegacySites <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_coordinates</span>()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust inclusion probability of neighbour hexagons in function of legacy sites</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>sampleFrame<span class="sc">$</span>adj_p <span class="ot">&lt;-</span> MBHdesign<span class="sc">::</span><span class="fu">alterInclProbs</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">legacy.sites =</span> legacySites,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">potential.sites =</span> coord_mt,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">inclusion.probs =</span> sampleFrame<span class="sc">$</span>mdcaty,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> bufferSize_p <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="primary-sampling-unit-psu" class="level2">
<h2 class="anchored" data-anchor-id="primary-sampling-unit-psu">Primary Sampling Unit (PSU)</h2>
<p>The <code>spsurvey</code> R package was used to implement the GRTS algorithm for sampling the PSUs of each ecoregion stratum. The sample size for each stratum, as defined in <code>Stratdsn</code>, is used to sample the hexagon points from the <code>sampleFrame</code> object. Note that the same sample size stratum is used for sampling the replacement (<code>n_over</code>) sites for each ecoregion stratum. Within each stratum, the sample selection is weighted based on the inclusion probability <code>adj_p</code>, which is derived from the habitat, cost, and legacy site layers. We replicate this sampling process <code>nb_rep</code> times, sum the total cost of sampling for the selected hexagons, and choose the replication with the lowest cost.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># list to store the hexagons ID (ET_Index) for the main and the replacement</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>grts_main <span class="ot">&lt;-</span> grts_over <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Run GRTS selection over nb_rep times</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(Rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb_rep)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    out_sample <span class="ot">&lt;-</span> spsurvey<span class="sc">::</span><span class="fu">grts</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">sframe =</span> sampleFrame,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_base =</span> Stratdsgn,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_over =</span> Stratdsgn,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">stratum_var =</span> <span class="st">'eco_name'</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">aux_var =</span> <span class="st">'adj_p'</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    grts_main[[<span class="fu">paste0</span>(<span class="st">'Rep_'</span>, Rep)]] <span class="ot">&lt;-</span> out_sample<span class="sc">$</span>sites_base<span class="sc">$</span>ET_Index</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    grts_over[[<span class="fu">paste0</span>(<span class="st">'Rep_'</span>, Rep)]] <span class="ot">&lt;-</span> out_sample<span class="sc">$</span>sites_over<span class="sc">$</span>ET_Index</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Select cheapest replication (based on 'main' selection)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>cheapest_rep <span class="ot">&lt;-</span> <span class="fu">map_df</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    grts_main,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(ET_Index <span class="sc">%in%</span> .x) <span class="sc">|&gt;</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">totalCost =</span> <span class="fu">sum</span>(costSum))</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="fu">pull</span>(totalCost) <span class="sc">|&gt;</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>()</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Save selected main and replacement hexagons</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>selected_main <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ET_Index <span class="sc">%in%</span> grts_main[[cheapest_rep]])</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>selected_over <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ET_Index <span class="sc">%in%</span> grts_over[[cheapest_rep]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Since the replacement hexagons are randomly selected in the stratum space, we also selected an extra layer of replacement hexagons that are obligatory neighbors of each main hexagon. For each selected main hexagon, we extract all neighboring hexagons and select the one with the highest inclusion probability. If a selected main hexagon has no available neighbor hexagon, we will select a random one over the ecoregion.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># object to store extra layer of selected hexagons</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>selected_extra <span class="ot">&lt;-</span> hexas[<span class="dv">0</span>, ]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over ecoregions to make sure neighbours are from the same ecoregion</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(eco <span class="cf">in</span> <span class="fu">parse_number</span>(<span class="fu">names</span>(Stratdsgn)))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    hexas_eco <span class="ot">&lt;-</span> <span class="fu">subset</span>(hexas, ecoregion <span class="sc">==</span> eco)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    hexas_sel_eco <span class="ot">&lt;-</span> <span class="fu">subset</span>(selected_main, ecoregion <span class="sc">==</span> eco)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract neighbours hexagons</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    neigh_mt <span class="ot">&lt;-</span> hexas_eco <span class="sc">|&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_centroid</span>() <span class="sc">|&gt;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_intersects</span>(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> <span class="fu">st_buffer</span>(hexas_sel_eco, <span class="at">dist =</span> <span class="dv">3500</span>),</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">sparse =</span> <span class="cn">FALSE</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the focus hexagon (the selected one)</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    rr <span class="ot">=</span> <span class="fu">match</span>(hexas_sel_eco<span class="sc">$</span>ET_Index, hexas_eco<span class="sc">$</span>ET_Index)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    cc <span class="ot">=</span> <span class="fu">seq_along</span>(rr)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    neigh_mt[rr <span class="sc">+</span> <span class="fu">nrow</span>(neigh_mt) <span class="sc">*</span> (cc <span class="sc">-</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select the extra hexagon based on the highest p</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    best_p <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        neigh_mt,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            hexas_eco<span class="sc">$</span>ET_Index[x][<span class="fu">which.max</span>(hexas_eco<span class="sc">$</span>p[x])]</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if a selected hexagon has no neighbour, select a random from the ecoregion</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    toCheck <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(best_p, length))</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(toCheck <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># which hexagons were not selected? </span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        nonSelected_hexas <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(hexas_eco<span class="sc">$</span>ET_Index, hexas_sel_eco<span class="sc">$</span>ET_Index)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample from non selected hexas</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        best_p[<span class="fu">which</span>(toCheck <span class="sc">==</span> <span class="dv">0</span>)] <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>            nonSelected_hexas, <span class="fu">sum</span>(toCheck <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    selected_extra <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        selected_extra,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        hexas_eco[<span class="fu">match</span>(best_p, hexas_eco<span class="sc">$</span>ET_Index), ]</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="secondary-sampling-unit-ssu" class="level2">
<h2 class="anchored" data-anchor-id="secondary-sampling-unit-ssu">Secondary Sampling Unit (SSU)</h2>
<p>For each of the selected PSU hexagons (<code>main</code>, <code>over</code>, and <code>extra</code>), we generate a grid of SSU points equally spaced with a distance defined by <code>ssu_dist</code>. The following function to generate SSUs is from the Ontario’s sampling approach (<a href="https://github.com/dhope/BASSr">code source</a>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>genSSU <span class="ot">&lt;-</span> <span class="cf">function</span>(h, spacing)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    ch <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">st_coordinates</span>(h))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    top_point <span class="ot">&lt;-</span> ch[<span class="fu">which.max</span>(ch<span class="sc">$</span>Y),]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    bottom_point <span class="ot">&lt;-</span> ch[<span class="fu">which.min</span>(ch<span class="sc">$</span>Y),]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    gridsize <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">floor</span>(<span class="fu">abs</span>(top_point<span class="sc">$</span>Y<span class="sc">-</span>bottom_point<span class="sc">$</span>Y)<span class="sc">/</span>spacing)<span class="sc">+</span><span class="dv">3</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    rowAngle <span class="ot">&lt;-</span> <span class="fu">tanh</span>((top_point<span class="sc">$</span>X<span class="sc">-</span>bottom_point<span class="sc">$</span>X)<span class="sc">/</span>(top_point<span class="sc">$</span>Y<span class="sc">-</span>bottom_point<span class="sc">$</span>Y))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    cent <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(h) <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bind_cols</span>(<span class="fu">as_tibble</span>(<span class="fu">st_coordinates</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        st_drop_geometry <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(ET_Index, X, Y)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    genRow <span class="ot">&lt;-</span> <span class="cf">function</span>(cX, cY, sp,...){</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(<span class="at">rowid =</span> <span class="fu">seq</span>(<span class="sc">-</span>gridsize,gridsize)) <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">sin</span>(<span class="dv">60</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">180</span><span class="sc">+</span>rowAngle) <span class="sc">*</span>sp<span class="sc">*</span>rowid <span class="sc">+</span> {{cX}},</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">Y =</span> <span class="fu">cos</span>(<span class="dv">60</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">180</span><span class="sc">+</span>rowAngle) <span class="sc">*</span>sp<span class="sc">*</span>rowid  <span class="sc">+</span> {{cY}})</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    centroids <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">crowid=</span><span class="fu">seq</span>(<span class="sc">-</span>gridsize,gridsize)) <span class="sc">%&gt;%</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">cY =</span> <span class="fu">cos</span>(rowAngle) <span class="sc">*</span>spacing<span class="sc">*</span>crowid <span class="sc">+</span> cent<span class="sc">$</span>Y,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">#spacing/2*crowid + cent$Y,</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">cX =</span>  <span class="fu">sin</span>(rowAngle) <span class="sc">*</span>spacing<span class="sc">*</span>crowid <span class="sc">+</span> cent<span class="sc">$</span>X) <span class="sc">%&gt;%</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">#cent$X + crowid* sqrt(spacing**2-(spacing/2)**2)) %&gt;%</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">list</span>(<span class="fu">genRow</span>(<span class="at">cX =</span> cX,<span class="at">cY =</span> cY,<span class="at">sp =</span> spacing))) <span class="sc">%&gt;%</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unnest</span>(row) <span class="sc">|&gt;</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y) <span class="sc">%&gt;%</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="fu">st_crs</span>(h)) <span class="sc">%&gt;%</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_filter</span>(h) <span class="sc">%&gt;%</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">ET_Index =</span> h<span class="sc">$</span>ET_Index,</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">ecoregion =</span> h<span class="sc">$</span>ecoregion,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">ssuID =</span> <span class="fu">row_number</span>()</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(centroids)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The following step involves defining a function to sample the SSUs within each selected PSU hexagon. SSU sampling is done sequentially, so for each selected SSU, the first and second layers of neighbour points (6 and 12, respectively) are made unavailable for sampling the next SSU. We repeat this process until we reach the total sampling size (<code>ssu_N</code>) or when there are no more available SSUs left to sample.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sample_SSU <span class="ot">&lt;-</span> <span class="cf">function</span>(ssuid, prob, geom, filtered, ssuDist, N)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check if N is even</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(N <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">'`ssu_N` must be a even number.'</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    filtered_1 <span class="ot">&lt;-</span> filtered</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(filtered))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop to sample N SSUs</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        count <span class="sc">&lt;=</span> N <span class="sc">&amp;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count))) <span class="sc">&gt;</span> <span class="dv">1</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample point</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assign</span>(</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'sample_'</span>, count),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                ssuid[<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count))],</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> prob[<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count))]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove points around the first sample for second point</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        toKeep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">st_intersects</span>(</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>            geom,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_buffer</span>(</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>                geom[<span class="fu">which</span>(<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'sample_'</span>, count)) <span class="sc">==</span> ssuid)],</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">dist =</span> ssuDist <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> ssuDist <span class="sc">*</span> <span class="fl">0.1</span>),</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>                <span class="at">sparse =</span> <span class="cn">FALSE</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        )[, <span class="dv">1</span>]</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update available points</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assign</span>(</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count)) <span class="sc">&amp;</span> toKeep</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># assign point to output vector</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        out[<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'sample_'</span>, count))] <span class="ot">=</span> count</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>        count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>( out )</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With these two functions, we can loop over the <code>main</code>, <code>over</code>, and <code>extra</code> selected hexagons to create and sample SSU points. First, we create the SSU points for all selected hexagons. Then, we generate a buffer around each SSU point with a distance of <code>ssu_dist/2</code>. We use the habitat pixels within each buffer to calculate the inclusion probability and the proportion of NA pixels. To save computation time, we compute and store the six neighbour points around each SSU point. Before sampling the SSU points, we classify each point as available or not following these rules:</p>
<ul>
<li>it must have 6 neighbours (less than that means it’s a border SSU)</li>
<li>it must have at least 1 - <code>prop_na</code> of non-empty pixels</li>
<li>4 out of 6 neighbours must also meet these rules</li>
</ul>
<p>In the final step, we assign a specific code to each selected SSU point and its neighbors, following the <code>A_B</code> pattern, where <code>A</code> represents the SSU sample ID (ranging from 1 to <code>ssu_N</code>), and <code>B</code> represents the neighbor ID (ranging from 0 to 6). Here, 0 represents the focal point, and 1 to 6 represent the six neighbors, starting from the top point and moving clockwise. please refer to <a href="SSU.html"><span>Chapter&nbsp;7</span></a> for more details.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Habitat shapefile to calculate inclusion probability</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>land_ca <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'landcover_ca_30m.tif'</span>))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of habitat types per ecoregion</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>prev_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'prev_all.RDS'</span>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    sel_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'selected_'</span>, lyr))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate SSU points</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    SSUs <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">seq_len</span>(<span class="fu">nrow</span>(sel_lyr)),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> <span class="fu">genSSU</span>(sel_lyr[.x, ], <span class="at">spacing =</span> ssu_dist)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buffer of half `ssu_dist` to compute habitat inclusion prob</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    SSU_bf <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(SSUs, <span class="at">dist =</span> ssu_dist<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract pixels for each SSU polygon</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    hab_pixels <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        land_ca,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        SSU_bf,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">progress =</span> <span class="cn">FALSE</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(SSU_bf)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get frequence of each class of habitat</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    count_hab <span class="ot">&lt;-</span> <span class="fu">Map</span>(</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(x, y) {</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                    freq <span class="ot">&lt;-</span> <span class="fu">table</span>(x<span class="sc">$</span>value)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">length</span>(freq) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">data.frame</span>(freq, <span class="at">ecoregion =</span> y)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>                    }<span class="cf">else</span>{</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>                        <span class="cn">NA</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                <span class="at">x =</span> hab_pixels,</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> SSUs<span class="sc">$</span>ecoregion</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># merge with inclusion probability</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and calculate inclusion probability for each NON empty polygon</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    SSUs<span class="sc">$</span>incl_prob <span class="ot">&lt;-</span> <span class="fu">unlist</span>(</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">lapply</span>(</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>                count_hab,</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(x) {</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(x)) {</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>                        mg_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>                            x,</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">subset</span>(</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>                                prev_all, ID_ecoregion <span class="sc">==</span> x<span class="sc">$</span>ecoregion[<span class="dv">1</span>]</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>                            ),</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by.x =</span> <span class="st">"Var1"</span>,</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by.y =</span> <span class="st">"code"</span>,</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>                            <span class="at">all.x =</span> <span class="cn">TRUE</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sum</span>(mg_df<span class="sc">$</span>Freq <span class="sc">*</span> mg_df<span class="sc">$</span>incl_prob)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>                    }<span class="cf">else</span>{</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>                        <span class="cn">NA</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(count_hab)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    SSUs <span class="ot">&lt;-</span> SSUs <span class="sc">|&gt;</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(ET_Index) <span class="sc">|&gt;</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>            <span class="at">incl_prob =</span> incl_prob<span class="sc">/</span><span class="fu">sum</span>(incl_prob, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate proportion of NA</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    SSUs<span class="sc">$</span>propNA <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>        hab_pixels,</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(.x<span class="sc">$</span>value))<span class="sc">/</span><span class="fu">nrow</span>(.x)</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(hab_pixels)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># neighbours matrix</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    neighbour_ls <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(hx <span class="cf">in</span> <span class="fu">unique</span>(SSUs<span class="sc">$</span>ET_Index))</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>        ssuhx <span class="ot">&lt;-</span> <span class="fu">subset</span>(SSUs, ET_Index <span class="sc">==</span> hx)</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>        neighbour_ls[[hx]] <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>            ssuhx,</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_buffer</span>(ssuhx, <span class="at">dist =</span> ssu_dist <span class="sc">+</span> ssu_dist <span class="sc">*</span> <span class="fl">0.1</span>),</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>            <span class="at">sparse =</span> <span class="cn">FALSE</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These are the following rules to a SSU be suitable for sampling:</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Must have 6 neighbours (less than that means it's a border SSU)</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Must have at least 1 - `prop_na` of non empty pixels</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - 4 out 6 neighbours must also respect the above rule</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    SSU_selected <span class="ot">=</span> SSUs <span class="sc">|&gt;</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(ET_Index) <span class="sc">|&gt;</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>            <span class="at">nbNeighb =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>                ssuID,</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">sum</span>(neighbour_ls[[<span class="fu">unique</span>(ET_Index)]][, .x]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>            <span class="at">nbPropNA =</span> <span class="fu">map_int</span>(</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>                ssuID,</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>                <span class="at">.f =</span> <span class="cf">function</span>(x, pNA, ETI)</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sum</span>(</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>                        pNA[</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">setdiff</span>(<span class="fu">which</span>(neighbour_ls[[ETI]][, x]), x)</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>                        ] <span class="sc">&lt;=</span> prop_na</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>                <span class="at">pNA =</span> propNA,</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>                <span class="at">ETI =</span> <span class="fu">unique</span>(ET_Index)</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>            <span class="at">sampled =</span> <span class="fu">sample_SSU</span>(</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>                <span class="at">ssuid =</span> ssuID,</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> incl_prob,</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>                <span class="at">geom =</span> geometry,</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>                <span class="at">filtered =</span> propNA <span class="sc">&lt;=</span> prop_na <span class="sc">&amp;</span> nbNeighb <span class="sc">==</span> <span class="dv">6</span>  <span class="sc">&amp;</span> nbPropNA <span class="sc">&gt;=</span> <span class="dv">4</span>,</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>                <span class="at">ssuDist =</span> ssu_dist,</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>                <span class="at">N =</span> ssu_N</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare selected SSU and their specific neighbours with code like `A_B`</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `A` is for the SSU sample ID (1:`ssu_N`)</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `B` is for the neighbour ID (0:6 where zero is the focal point, and</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1:6 are the 6 neighbours starting from the top point moving clockwise)</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="ot">&lt;-</span> <span class="fu">subset</span>(SSU_selected, sampled <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>    SSU_lyr_ls <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SSU_lyr))</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get neighbours for specific row</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>        nei_hx <span class="ot">&lt;-</span> SSU_selected <span class="sc">|&gt;</span> </span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(ET_Index <span class="sc">==</span> SSU_lyr<span class="sc">$</span>ET_Index[i]) <span class="sc">|&gt;</span> </span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>                ssuID <span class="sc">%in%</span> <span class="fu">which</span>(</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>                    neighbour_ls[[SSU_lyr<span class="sc">$</span>ET_Index[i]]][, SSU_lyr<span class="sc">$</span>ssuID[i]]</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code A </span></span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>        nei_hx<span class="sc">$</span>codeA <span class="ot">&lt;-</span> SSU_lyr<span class="sc">$</span>sampled[i]</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code B</span></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>        nei_hx<span class="sc">$</span>codeB <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">1</span>)</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>        SSU_lyr_ls[[i]] <span class="ot">&lt;-</span> nei_hx</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assign</span>(</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">'SSU_all_'</span>, lyr),</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>        SSU_selected</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assign</span>(</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">'SSU_'</span>, lyr),</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>        <span class="fu">do.call</span>(rbind, SSU_lyr_ls)</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="export-psu-and-ssu-samples-in-shapefiles" class="level2">
<h2 class="anchored" data-anchor-id="export-psu-and-ssu-samples-in-shapefiles">Export PSU and SSU samples in shapefiles</h2>
<p>The purpose of this final section is to export all PSU and SSU points in a shapefile format. The format was chosen to facilitate post-processing, but it can be modified to fit different needs. The first code chunk saves all PSU and SSU points into a single file, while the second code chunk separates the same sampled points by ecoregion.</p>
<section id="grouped-ecoregions" class="level4">
<h4 class="anchored" data-anchor-id="grouped-ecoregions">Grouped ecoregions</h4>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>savePath <span class="ot">=</span> <span class="fu">file.path</span>(outputFolder, <span class="st">'allEcoregion'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(savePath, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>varsToRm <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'OBJECTID'</span>, <span class="st">'Join_Count'</span>, <span class="st">'TARGET_FID'</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ET_ID'</span>, <span class="st">'ET_ID_Old'</span>, <span class="st">'ET_IDX_Old'</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>hexas_save <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">all_of</span>(varsToRm))</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co"># rename attributes table so it has a maximum of 10 characters</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hexas_save) <span class="ot">&lt;-</span> <span class="fu">abbreviate</span>(<span class="fu">names</span>(hexas_save), <span class="at">minlength =</span> <span class="dv">10</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># add coordinates</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> hexas_save <span class="sc">|&gt;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_centroid</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>()</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>hexas_save <span class="ot">&lt;-</span> hexas_save <span class="sc">|&gt;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co"># save all PSU</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>hexas_save <span class="sc">|&gt;</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_sf</span>(</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">file.path</span>(</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>            savePath,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'PSU-SOBQ_ALL-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Selected PSUs</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    hexas_save <span class="sc">|&gt;</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>            ET_Index <span class="sc">%in%</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'selected_'</span>, lyr))<span class="sc">$</span>ET_Index</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>                savePath,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'PSU-SOBQ_'</span>, lyr, <span class="st">'-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Save all SSU</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSU main</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_all_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.frame</span>()</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>            <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>            <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>                savePath,</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'SSU-SOBQ_ALL_'</span>, lyr, <span class="st">'-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Save selected SSU</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSU main</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.frame</span>()</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>            <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>            <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>                savePath,</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'SSU-SOBQ_selected_'</span>, lyr, <span class="st">'-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="splited-ecoregions" class="level4">
<h4 class="anchored" data-anchor-id="splited-ecoregions">Splited ecoregions</h4>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(eco <span class="cf">in</span> eco_sim)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create folder</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    eco_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        outputFolder,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'byEcoregion'</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">'ecoregion_'</span>, eco)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(eco_path, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PSU</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################################</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    hexas_save <span class="sc">|&gt;</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                eco_path,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'PSU-SOBQ_eco'</span>, eco, <span class="st">'_ALL-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        hexas_save <span class="sc">|&gt;</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                ET_Index <span class="sc">%in%</span> <span class="fu">subset</span>(</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'selected_'</span>, lyr)),</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                    ecoregion <span class="sc">==</span> eco</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                )<span class="sc">$</span>ET_Index</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>            <span class="fu">write_sf</span>(</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>                <span class="fu">file.path</span>(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                    eco_path,</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'PSU-SOBQ_eco'</span>,</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                        eco, <span class="st">'_'</span>,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                        lyr, <span class="st">'-'</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                        fileSuffix,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'.shp'</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSU</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################################</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save all SSU</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SSU main</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_all_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.data.frame</span>()</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>                <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>                <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>            <span class="fu">write_sf</span>(</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>                <span class="fu">file.path</span>(</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>                    eco_path,</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'SSU-SOBQ_eco'</span>,</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>                        eco,</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'_ALL_'</span>,</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>                        lyr, <span class="st">'-'</span>,</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>                        fileSuffix,</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'.shp'</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save selected SSU</span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SSU main</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>        coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.data.frame</span>()</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>                <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>                <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>            <span class="fu">write_sf</span>(</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>                <span class="fu">file.path</span>(</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>                    eco_path,</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'SSU-SOBQ_eco'</span>,</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>                        eco,</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'_selected_'</span>,</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>                        lyr, <span class="st">'-'</span>,</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>                        fileSuffix,</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'.shp'</span></span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./SSU.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Secondary sampling unity</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ecosumm_habitat.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Ecoregion summary: habitat</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb17" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "A guide for BMS sampling design with R"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup,echo=FALSE}</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>Eval<span class="ot">=</span><span class="cn">FALSE</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>In this section, we will provide an overview and explanation of the code used for the final step of the BMS sampling design.</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>This report is designed to be self-contained and provides all the necessary steps for processing the data layers in conjunction with the GRTS algorithm to perform the sampling.</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>The complete procedure, including code for data preparation and analysis, is organized in sequential R scripts and can be found in the <span class="co">[</span><span class="ot">GitHub repository</span><span class="co">](https://github.com/willvieira/sampling_BMS/)</span>. This specific report refers to the R script <span class="co">[</span><span class="ot">`08_runGRTS.R`</span><span class="co">](https://github.com/willvieira/sampling_BMS/blob/main/08_runGRTS.R)</span>.</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>Bellow we list the packages used in the sampling process.</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>Note that the code described in the report is only compatible with spsurvey R package versions v5.0 and above.</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>For consistent results, we recommend loading the same environment that was used in this project, which is saved in the <span class="in">`renv.lock`</span> file.</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>The following steps can be used to load the same environment:</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load enviroment,eval=Eval}</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co"># install `renv` package if necessary</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(renv)) <span class="fu">install.packages</span>(<span class="st">'renv'</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Restore the project environment</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">activate</span>(<span class="at">project =</span> <span class="st">"/path/to/project"</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>The first line of code will check load (and install if necessary) the R pacakge <span class="in">`renv`</span> to manage the version of the dependences.</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>The <span class="in">`activate()`</span> function will install all necessary packages with their respective version into a local container accessible only by this project.</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>If you're not already in the path of the project, make sure to replace <span class="in">`/path/to/project`</span> with the path to the directory where the project is stored.</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loadPackages,results='hide',message=FALSE,warning=FALSE,eval=Eval}</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatstat)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spsurvey)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MBHdesign)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="co"># to reproduce the same results</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="fl">0.0</span>)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="fu">## Custom parameters</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>Here is the main section the user will need to interact.</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>Below is a list of all the variables that can be used to customize the sampling process, each accompanied by detailed comments.</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{r parameters,eval=Eval}</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold to determine whether a hexagon is suitable for sampling is based on</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a><span class="co"># the proportion of NA pixels (non-natural habitat).</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="co"># `0.8` means a hexagon has to have at least 20% of habitat pixels to be</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a><span class="co"># suitable for sampling</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>prop_na <span class="ot">=</span> <span class="fl">0.8</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample effort in percentage</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>sample_effort <span class="ot">=</span> <span class="fl">0.02</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Total sample size for SSU within a hexagon (Main + Over)</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a><span class="co"># It must be an even numbers</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>ssu_N <span class="ot">=</span> <span class="dv">6</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of replications when selecting the PSU with the GRTS algorithm</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>nb_rep <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Code of ecoregions to sample</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>eco_sim <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">'7'</span>, <span class="st">'28'</span>, <span class="st">'30'</span>, <span class="st">'31'</span>,</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46'</span>, <span class="st">'47'</span>, <span class="st">'48'</span>, <span class="st">'49'</span>,</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'73'</span>, <span class="st">'77'</span>, <span class="st">'78'</span>, <span class="st">'86'</span>,</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'72'</span>, <span class="st">'74'</span>, <span class="st">'75'</span>, <span class="st">'76'</span>,</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">'96'</span>, <span class="st">'99'</span>, <span class="st">'100'</span>, <span class="st">'101'</span>,</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">'102'</span>, <span class="st">'103'</span>, <span class="st">'117'</span>,</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">'216'</span>, <span class="st">'217'</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a><span class="co"># File path of the csv file used to store the legacy sites</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a><span class="co"># E.g. https://github.com/willvieira/sampling_BMS/blob/main/data/legacySites.csv</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a><span class="co"># `lat` and `lon` arguments are used to define the character name of the</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a><span class="co"># columns in the csv</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>and columns to extract legacy sites</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>legacyFile <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'legacySites.csv'</span>)</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>lat <span class="ot">=</span> <span class="st">'latitude'</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>lon <span class="ot">=</span> <span class="st">'longitude'</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Buffer size (in Km) to adjust inclusion probability of hexagons around the</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a><span class="co"># legacy sites using the MBHdesign R package</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>bufferSize_p <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Buffer size (in Km) to adjust the sample size of an ecoregion as a function of</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a><span class="co"># the number and distribution of its legacy sites</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a><span class="co"># The value provided can either be a single number applied to all ecoregions or</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="co"># a file path containing the buffer size information for each ecoregion.</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a><span class="co"># E.g.https://github.com/willvieira/sampling_BMS/blob/main/data/bufferSize_N.csv</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>bufferSize_N <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'bufferSize_N.csv'</span>)</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to assign the same buffer size (in Km) for all ecoregion:</span></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a><span class="co"># bufferSize_N = 15</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance between SSU centroid (in meters)</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>ssu_dist <span class="ot">=</span> <span class="dv">294</span></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to save the shapefiles with the selected PSU and SSU</span></span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>outputFolder <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">'output'</span>, <span class="st">'selection2023'</span>)</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a><span class="co"># suffix to add for each output layer</span></span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g.: PSU-SOQB_ALL-SUFFIX.shp</span></span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>fileSuffix <span class="ot">=</span> <span class="st">'V2023'</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prepare layers for sampling</span></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>The first step is loading the complete hexagons list within the study area.</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>While loading, we keep only the hexagons for the ecoregions of interest (<span class="in">`eco_sim`</span>) and remove the hexagons with too many NA habitats.</span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>We then compute the hexagon inclusion probability from the habitat and cost layers normalized for the study area.</span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loadHex,eval=Eval}</span></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>hexas <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'hexa_complete.RDS'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(propNA <span class="sc">&lt;=</span> prop_na) <span class="sc">|&gt;</span></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ecoregion <span class="sc">%in%</span> eco_sim) <span class="sc">|&gt;</span></span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">p =</span> (hab_prob <span class="sc">*</span> cost_prob) <span class="sc">/</span> <span class="fu">sum</span>(hab_prob <span class="sc">*</span> cost_prob)</span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(p <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>The legacy sites are the second layer of information needed to run the GRTS.</span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>Bellow the code is written to load the list of coordinate points from the legacy sites and create a data frame describing the count number of legacy sites per hexagon.</span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>This procedure scales the point data to the hexagon level, allowing us to modify the inclusion probability of the neighboring hexagons and adjust the ecoregion sample size.</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r legacySites,warning=FALSE,message=FALSE,eval=Eval}</span></span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a><span class="co"># function to transform Latitude &amp; longitude legacy site points in a table</span></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a><span class="co"># with the number of points per hexagon ID (ET_Index)</span></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>import_legacySites <span class="ot">&lt;-</span> <span class="cf">function</span>(File, lat_name, lon_name)</span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># transform hexagons projection to the same of the legacy points</span></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>    hx <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># read legacy csv file</span></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>    lg <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(File, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>            <span class="at">lat =</span> <span class="fu">all_of</span>(lat_name),</span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>            <span class="at">lon =</span> <span class="fu">all_of</span>(lon_name)</span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_sf</span>(</span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>            <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">'lon'</span>, <span class="st">'lat'</span>),</span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a>            <span class="at">crs =</span> <span class="fu">st_crs</span>(hx)</span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intersect legacy points with hexagon polygons</span></span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>    nbLegacy <span class="ot">&lt;-</span> hx <span class="sc">|&gt;</span></span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_contains</span>(lg, <span class="at">sparse =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a>        <span class="fu">apply</span>(<span class="dv">1</span>, sum)</span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return a transformed data to data.frame</span></span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and keep only the hexagons that contains legacy sites</span></span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a>        <span class="at">ET_Index =</span> hx<span class="sc">$</span>ET_Index,</span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a>        <span class="at">nbLegacySites =</span> nbLegacy</span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(nbLegacySites <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a><span class="co"># load and transform legacy sites (slow function)</span></span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a>legacySites <span class="ot">&lt;-</span> <span class="fu">import_legacySites</span>(</span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">File =</span> legacyFile,</span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_name =</span> lat,</span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_name =</span> lon</span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a><span class="co"># merge legacy sites data.frame into hexagon object</span></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>hexas <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(legacySites) <span class="sc">|&gt;</span></span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nbLegacySites =</span> <span class="fu">replace_na</span>(nbLegacySites, <span class="dv">0</span>))</span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adjust sample size and inclusion probability as a function of legacy sites</span></span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a>After merging the hexagons and legacy sites, the next step is to adjust the sample size and modify the inclusion probabilities.</span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a>The sample size, defined in the number of hexagons, is defined in function of the size of the ecoregion, the sampling effort (<span class="in">`sample_effort`</span>), and the number of legacy sites.</span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>The input <span class="in">`bufferSize_N`</span> quantify the effect of each legacy site in reducing the final sample size.</span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a>The value provided can either be a single number that will be applied to all ecoregions or a file path that contains the buffer size information for each individual ecoregion.</span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>For more details on defining the buffer size to adjust the sample size, please refer to @sec-legacy-sites.</span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sampleSizeF,warning=FALSE,message=FALSE,eval=Eval}</span></span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a><span class="co"># function to get sample size for a specific ecoregion given:</span></span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a><span class="co"># number of hexagons, number of legacy sites, bufferSize, and sample effort</span></span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a>get_sampleSize <span class="ot">&lt;-</span> <span class="cf">function</span>(eco, hx, bf_N, sample_e)</span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the hexagons centroid for a specific ecoregion</span></span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a>    hexa_eco <span class="ot">&lt;-</span> hx <span class="sc">|&gt;</span></span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_centroid</span>()</span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(<span class="fu">subset</span>(bf_N, ecoregion <span class="sc">==</span> eco)) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create a buffer of size `BufferSize_N` around the legacy site centroid</span></span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a>        hexa_legacy_bf <span class="ot">&lt;-</span> hexa_eco <span class="sc">|&gt;</span></span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(nbLegacySites <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_buffer</span>(<span class="fu">subset</span>(bf_N, ecoregion <span class="sc">==</span> eco)<span class="sc">$</span>bufferSize <span class="sc">*</span> <span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_union</span>()</span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the number of hexagons from the ecoregion in which their</span></span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># centroid falls within the buffer around the legacy sites</span></span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a>        nbHexas_legacy <span class="ot">&lt;-</span> hexa_eco <span class="sc">|&gt;</span></span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_intersects</span>(hexa_legacy_bf) <span class="sc">|&gt;</span></span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a>            <span class="fu">unlist</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>()</span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a>        nbHexas_legacy <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the adjusted sample size using only the total amount of hexagons</span></span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that do not fall within the legacy buffer</span></span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a>    adj_sampleSize <span class="ot">&lt;-</span> <span class="fu">round</span>((<span class="fu">nrow</span>(hexa_eco) <span class="sc">-</span> nbHexas_legacy) <span class="sc">*</span> sample_e, <span class="dv">0</span>)</span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the ecoregion is too small to accommodate 2 hexagons with the defined</span></span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sampling effort, ensure to sample at least two hexagons.</span></span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>((<span class="fu">nrow</span>(hexa_eco) <span class="sc">*</span> sample_e) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">&amp;</span> nbHexas_legacy <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a>        adj_sampleSize <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(adj_sampleSize)</span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loadBuffFile,warning=FALSE,message=FALSE,eval=Eval}</span></span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Load buffer size information regardless of the `byfferSize_N` class</span></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">is.character</span>(bufferSize_N)) {</span>
<span id="cb17-234"><a href="#cb17-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">file.exists</span>(bufferSize_N)) {</span>
<span id="cb17-235"><a href="#cb17-235" aria-hidden="true" tabindex="-1"></a>        buffSizeN <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(bufferSize_N, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-236"><a href="#cb17-236" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">ecoregion =</span> <span class="fu">as.character</span>(ecoregion))</span>
<span id="cb17-237"><a href="#cb17-237" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(</span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'File "'</span>, bufferSize_N,</span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a>            <span class="st">'" does not exist. Please check if the name is correct.'</span>)</span>
<span id="cb17-241"><a href="#cb17-241" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-242"><a href="#cb17-242" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-243"><a href="#cb17-243" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.numeric</span>(bufferSize_N)){</span>
<span id="cb17-244"><a href="#cb17-244" aria-hidden="true" tabindex="-1"></a>    buffSizeN <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb17-245"><a href="#cb17-245" aria-hidden="true" tabindex="-1"></a>        <span class="at">ecoregion =</span> eco_sim,</span>
<span id="cb17-246"><a href="#cb17-246" aria-hidden="true" tabindex="-1"></a>        <span class="at">bufferSize =</span> bufferSize_N</span>
<span id="cb17-247"><a href="#cb17-247" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-248"><a href="#cb17-248" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb17-249"><a href="#cb17-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">'The type of `bufferSize_N` must be either numeric or a character'</span>)</span>
<span id="cb17-250"><a href="#cb17-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-251"><a href="#cb17-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-252"><a href="#cb17-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-253"><a href="#cb17-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r RunsampleSizeF,warning=FALSE,message=FALSE,eval=Eval}</span></span>
<span id="cb17-254"><a href="#cb17-254" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the function to define sample size for all selected ecoregions</span></span>
<span id="cb17-255"><a href="#cb17-255" aria-hidden="true" tabindex="-1"></a>sampleSize <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb17-256"><a href="#cb17-256" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(eco_sim, <span class="fu">paste0</span>(<span class="st">'eco_'</span>, eco_sim)),</span>
<span id="cb17-257"><a href="#cb17-257" aria-hidden="true" tabindex="-1"></a>    get_sampleSize,</span>
<span id="cb17-258"><a href="#cb17-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">hx =</span> hexas,</span>
<span id="cb17-259"><a href="#cb17-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">bf_N =</span> buffSizeN,</span>
<span id="cb17-260"><a href="#cb17-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_e =</span> sample_effort</span>
<span id="cb17-261"><a href="#cb17-261" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-262"><a href="#cb17-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-263"><a href="#cb17-263" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stratum object with ecoregion that have</span></span>
<span id="cb17-264"><a href="#cb17-264" aria-hidden="true" tabindex="-1"></a><span class="co"># at least a sample size of 1</span></span>
<span id="cb17-265"><a href="#cb17-265" aria-hidden="true" tabindex="-1"></a>Stratdsgn  <span class="ot">&lt;-</span> sampleSize[sampleSize <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb17-266"><a href="#cb17-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-267"><a href="#cb17-267" aria-hidden="true" tabindex="-1"></a><span class="co"># Because we are sampling an extra hexagon for each selected one,</span></span>
<span id="cb17-268"><a href="#cb17-268" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure that each ecoregion has at least 2 times more available</span></span>
<span id="cb17-269"><a href="#cb17-269" aria-hidden="true" tabindex="-1"></a><span class="co"># hexagons than sample N</span></span>
<span id="cb17-270"><a href="#cb17-270" aria-hidden="true" tabindex="-1"></a>eco_to_remove <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-271"><a href="#cb17-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-272"><a href="#cb17-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ecoregion) <span class="sc">|&gt;</span></span>
<span id="cb17-273"><a href="#cb17-273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">nbHexas =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb17-274"><a href="#cb17-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb17-275"><a href="#cb17-275" aria-hidden="true" tabindex="-1"></a>        sampleSize <span class="sc">|&gt;</span></span>
<span id="cb17-276"><a href="#cb17-276" aria-hidden="true" tabindex="-1"></a>            <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-277"><a href="#cb17-277" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb17-278"><a href="#cb17-278" aria-hidden="true" tabindex="-1"></a>                <span class="at">ecoregion =</span> <span class="fu">as.character</span>(<span class="fu">parse_number</span>(name)),</span>
<span id="cb17-279"><a href="#cb17-279" aria-hidden="true" tabindex="-1"></a>                <span class="at">sampleSize_extra =</span> value <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb17-280"><a href="#cb17-280" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb17-281"><a href="#cb17-281" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(ecoregion, sampleSize_extra)</span>
<span id="cb17-282"><a href="#cb17-282" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb17-283"><a href="#cb17-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb17-284"><a href="#cb17-284" aria-hidden="true" tabindex="-1"></a>        <span class="at">diff =</span> nbHexas <span class="sc">-</span> sampleSize_extra</span>
<span id="cb17-285"><a href="#cb17-285" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb17-286"><a href="#cb17-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(diff <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-287"><a href="#cb17-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(ecoregion)</span>
<span id="cb17-288"><a href="#cb17-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-289"><a href="#cb17-289" aria-hidden="true" tabindex="-1"></a>Stratdsgn <span class="ot">&lt;-</span> Stratdsgn[<span class="sc">!</span><span class="fu">names</span>(Stratdsgn) <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">'eco_'</span>, eco_to_remove)]</span>
<span id="cb17-290"><a href="#cb17-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-291"><a href="#cb17-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare sample frame to be used in GRTS</span></span>
<span id="cb17-292"><a href="#cb17-292" aria-hidden="true" tabindex="-1"></a><span class="co"># scale inclusion probability to the total sample size</span></span>
<span id="cb17-293"><a href="#cb17-293" aria-hidden="true" tabindex="-1"></a><span class="co"># Use only the centroid of the hexagon as a sample point</span></span>
<span id="cb17-294"><a href="#cb17-294" aria-hidden="true" tabindex="-1"></a>sampleFrame <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-295"><a href="#cb17-295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ecoregion <span class="sc">%in%</span> <span class="fu">parse_number</span>(<span class="fu">names</span>(Stratdsgn))) <span class="sc">|&gt;</span></span>
<span id="cb17-296"><a href="#cb17-296" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(    </span>
<span id="cb17-297"><a href="#cb17-297" aria-hidden="true" tabindex="-1"></a>        <span class="at">eco_name =</span> <span class="fu">paste0</span>(<span class="st">'eco_'</span>, ecoregion), <span class="co"># to match design name</span></span>
<span id="cb17-298"><a href="#cb17-298" aria-hidden="true" tabindex="-1"></a>        <span class="at">mdcaty  =</span> <span class="fu">sum</span>(Stratdsgn) <span class="sc">*</span> p<span class="sc">/</span><span class="fu">sum</span>(p),</span>
<span id="cb17-299"><a href="#cb17-299" aria-hidden="true" tabindex="-1"></a>        <span class="at">geometry =</span> sf<span class="sc">::</span><span class="fu">st_geometry</span>(sf<span class="sc">::</span><span class="fu">st_centroid</span>(geometry))</span>
<span id="cb17-300"><a href="#cb17-300" aria-hidden="true" tabindex="-1"></a>)   </span>
<span id="cb17-301"><a href="#cb17-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-302"><a href="#cb17-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-303"><a href="#cb17-303" aria-hidden="true" tabindex="-1"></a>The last step involves adjusting inclusion probabilities for neighboring hexagons around legacy sites.</span>
<span id="cb17-304"><a href="#cb17-304" aria-hidden="true" tabindex="-1"></a>To do this, we used the <span class="in">`MBHdesign`</span> R package and adjusted the inclusion probability based on the <span class="in">`bufferSize_p`</span> parameter.</span>
<span id="cb17-305"><a href="#cb17-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-306"><a href="#cb17-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r adjInclProb,warning=FALSE,message=FALSE,eval=Eval}</span></span>
<span id="cb17-307"><a href="#cb17-307" aria-hidden="true" tabindex="-1"></a><span class="co"># Coordinates of all hexagons in matrix format for MBHdesign</span></span>
<span id="cb17-308"><a href="#cb17-308" aria-hidden="true" tabindex="-1"></a>coord_mt <span class="ot">&lt;-</span> sampleFrame <span class="sc">|&gt;</span></span>
<span id="cb17-309"><a href="#cb17-309" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_coordinates</span>()</span>
<span id="cb17-310"><a href="#cb17-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-311"><a href="#cb17-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Coordinates of legacy hexagons</span></span>
<span id="cb17-312"><a href="#cb17-312" aria-hidden="true" tabindex="-1"></a>legacySites <span class="ot">&lt;-</span> sampleFrame <span class="sc">|&gt;</span></span>
<span id="cb17-313"><a href="#cb17-313" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(nbLegacySites <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-314"><a href="#cb17-314" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_coordinates</span>()</span>
<span id="cb17-315"><a href="#cb17-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-316"><a href="#cb17-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust inclusion probability of neighbour hexagons in function of legacy sites</span></span>
<span id="cb17-317"><a href="#cb17-317" aria-hidden="true" tabindex="-1"></a>sampleFrame<span class="sc">$</span>adj_p <span class="ot">&lt;-</span> MBHdesign<span class="sc">::</span><span class="fu">alterInclProbs</span>(</span>
<span id="cb17-318"><a href="#cb17-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">legacy.sites =</span> legacySites,</span>
<span id="cb17-319"><a href="#cb17-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">potential.sites =</span> coord_mt,</span>
<span id="cb17-320"><a href="#cb17-320" aria-hidden="true" tabindex="-1"></a>    <span class="at">inclusion.probs =</span> sampleFrame<span class="sc">$</span>mdcaty,</span>
<span id="cb17-321"><a href="#cb17-321" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> bufferSize_p <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb17-322"><a href="#cb17-322" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-323"><a href="#cb17-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-324"><a href="#cb17-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-325"><a href="#cb17-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-326"><a href="#cb17-326" aria-hidden="true" tabindex="-1"></a><span class="fu">## Primary Sampling Unit (PSU)</span></span>
<span id="cb17-327"><a href="#cb17-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-328"><a href="#cb17-328" aria-hidden="true" tabindex="-1"></a>The <span class="in">`spsurvey`</span> R package was used to implement the GRTS algorithm for sampling the PSUs of each ecoregion stratum.</span>
<span id="cb17-329"><a href="#cb17-329" aria-hidden="true" tabindex="-1"></a>The sample size for each stratum, as defined in <span class="in">`Stratdsn`</span>, is used to sample the hexagon points from the <span class="in">`sampleFrame`</span> object.</span>
<span id="cb17-330"><a href="#cb17-330" aria-hidden="true" tabindex="-1"></a>Note that the same sample size stratum is used for sampling the replacement (<span class="in">`n_over`</span>) sites for each ecoregion stratum.</span>
<span id="cb17-331"><a href="#cb17-331" aria-hidden="true" tabindex="-1"></a>Within each stratum, the sample selection is weighted based on the inclusion probability <span class="in">`adj_p`</span>, which is derived from the habitat, cost, and legacy site layers.</span>
<span id="cb17-332"><a href="#cb17-332" aria-hidden="true" tabindex="-1"></a>We replicate this sampling process <span class="in">`nb_rep`</span> times, sum the total cost of sampling for the selected hexagons, and choose the replication with the lowest cost.</span>
<span id="cb17-333"><a href="#cb17-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{r runGRTS, warning=FALSE,message=FALSE,eval=Eval}</span></span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a><span class="co"># list to store the hexagons ID (ET_Index) for the main and the replacement</span></span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a>grts_main <span class="ot">&lt;-</span> grts_over <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a><span class="co"># Run GRTS selection over nb_rep times</span></span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(Rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb_rep)</span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a>    out_sample <span class="ot">&lt;-</span> spsurvey<span class="sc">::</span><span class="fu">grts</span>(</span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">sframe =</span> sampleFrame,</span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_base =</span> Stratdsgn,</span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_over =</span> Stratdsgn,</span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a>        <span class="at">stratum_var =</span> <span class="st">'eco_name'</span>,</span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a>        <span class="at">aux_var =</span> <span class="st">'adj_p'</span></span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a>    grts_main[[<span class="fu">paste0</span>(<span class="st">'Rep_'</span>, Rep)]] <span class="ot">&lt;-</span> out_sample<span class="sc">$</span>sites_base<span class="sc">$</span>ET_Index</span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a>    grts_over[[<span class="fu">paste0</span>(<span class="st">'Rep_'</span>, Rep)]] <span class="ot">&lt;-</span> out_sample<span class="sc">$</span>sites_over<span class="sc">$</span>ET_Index</span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Select cheapest replication (based on 'main' selection)</span></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a>cheapest_rep <span class="ot">&lt;-</span> <span class="fu">map_df</span>(</span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a>    grts_main,</span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(ET_Index <span class="sc">%in%</span> .x) <span class="sc">|&gt;</span></span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">totalCost =</span> <span class="fu">sum</span>(costSum))</span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a><span class="fu">pull</span>(totalCost) <span class="sc">|&gt;</span></span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>()</span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a><span class="co"># Save selected main and replacement hexagons</span></span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a>selected_main <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ET_Index <span class="sc">%in%</span> grts_main[[cheapest_rep]])</span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a>selected_over <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ET_Index <span class="sc">%in%</span> grts_over[[cheapest_rep]])</span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a>Since the replacement hexagons are randomly selected in the stratum space, we also selected an extra layer of replacement hexagons that are obligatory neighbors of each main hexagon.</span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a>For each selected main hexagon, we extract all neighboring hexagons and select the one with the highest inclusion probability.</span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a>If a selected main hexagon has no available neighbor hexagon, we will select a random one over the ecoregion.</span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r neighbor, message=FALSE,warning=FALSE,eval=Eval}</span></span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a><span class="co"># object to store extra layer of selected hexagons</span></span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a>selected_extra <span class="ot">&lt;-</span> hexas[<span class="dv">0</span>, ]</span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over ecoregions to make sure neighbours are from the same ecoregion</span></span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(eco <span class="cf">in</span> <span class="fu">parse_number</span>(<span class="fu">names</span>(Stratdsgn)))</span>
<span id="cb17-380"><a href="#cb17-380" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-381"><a href="#cb17-381" aria-hidden="true" tabindex="-1"></a>    hexas_eco <span class="ot">&lt;-</span> <span class="fu">subset</span>(hexas, ecoregion <span class="sc">==</span> eco)</span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a>    hexas_sel_eco <span class="ot">&lt;-</span> <span class="fu">subset</span>(selected_main, ecoregion <span class="sc">==</span> eco)</span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract neighbours hexagons</span></span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a>    neigh_mt <span class="ot">&lt;-</span> hexas_eco <span class="sc">|&gt;</span></span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_centroid</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_intersects</span>(</span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> <span class="fu">st_buffer</span>(hexas_sel_eco, <span class="at">dist =</span> <span class="dv">3500</span>),</span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a>            <span class="at">sparse =</span> <span class="cn">FALSE</span></span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove the focus hexagon (the selected one)</span></span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a>    rr <span class="ot">=</span> <span class="fu">match</span>(hexas_sel_eco<span class="sc">$</span>ET_Index, hexas_eco<span class="sc">$</span>ET_Index)</span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a>    cc <span class="ot">=</span> <span class="fu">seq_along</span>(rr)</span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a>    neigh_mt[rr <span class="sc">+</span> <span class="fu">nrow</span>(neigh_mt) <span class="sc">*</span> (cc <span class="sc">-</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select the extra hexagon based on the highest p</span></span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a>    best_p <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a>        neigh_mt,</span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span>,</span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x)</span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a>            hexas_eco<span class="sc">$</span>ET_Index[x][<span class="fu">which.max</span>(hexas_eco<span class="sc">$</span>p[x])]</span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if a selected hexagon has no neighbour, select a random from the ecoregion</span></span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a>    toCheck <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(best_p, length))</span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(toCheck <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a>        <span class="co"># which hexagons were not selected? </span></span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a>        nonSelected_hexas <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(hexas_eco<span class="sc">$</span>ET_Index, hexas_sel_eco<span class="sc">$</span>ET_Index)</span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-411"><a href="#cb17-411" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample from non selected hexas</span></span>
<span id="cb17-412"><a href="#cb17-412" aria-hidden="true" tabindex="-1"></a>        best_p[<span class="fu">which</span>(toCheck <span class="sc">==</span> <span class="dv">0</span>)] <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a>            nonSelected_hexas, <span class="fu">sum</span>(toCheck <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a>    selected_extra <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a>        selected_extra,</span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a>        hexas_eco[<span class="fu">match</span>(best_p, hexas_eco<span class="sc">$</span>ET_Index), ]</span>
<span id="cb17-420"><a href="#cb17-420" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-421"><a href="#cb17-421" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-422"><a href="#cb17-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-423"><a href="#cb17-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-424"><a href="#cb17-424" aria-hidden="true" tabindex="-1"></a><span class="fu">## Secondary Sampling Unit (SSU)</span></span>
<span id="cb17-425"><a href="#cb17-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-426"><a href="#cb17-426" aria-hidden="true" tabindex="-1"></a>For each of the selected PSU hexagons (<span class="in">`main`</span>, <span class="in">`over`</span>, and <span class="in">`extra`</span>), we generate a grid of SSU points equally spaced with a distance defined by <span class="in">`ssu_dist`</span>.</span>
<span id="cb17-427"><a href="#cb17-427" aria-hidden="true" tabindex="-1"></a>The following function to generate SSUs is from the Ontario's sampling approach (<span class="co">[</span><span class="ot">code source</span><span class="co">](https://github.com/dhope/BASSr)</span>).</span>
<span id="cb17-428"><a href="#cb17-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-429"><a href="#cb17-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r funGridSSU,message=FALSE,warning=FALSE,eval=Eval}</span></span>
<span id="cb17-430"><a href="#cb17-430" aria-hidden="true" tabindex="-1"></a>genSSU <span class="ot">&lt;-</span> <span class="cf">function</span>(h, spacing)</span>
<span id="cb17-431"><a href="#cb17-431" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-432"><a href="#cb17-432" aria-hidden="true" tabindex="-1"></a>    ch <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">st_coordinates</span>(h))</span>
<span id="cb17-433"><a href="#cb17-433" aria-hidden="true" tabindex="-1"></a>    top_point <span class="ot">&lt;-</span> ch[<span class="fu">which.max</span>(ch<span class="sc">$</span>Y),]</span>
<span id="cb17-434"><a href="#cb17-434" aria-hidden="true" tabindex="-1"></a>    bottom_point <span class="ot">&lt;-</span> ch[<span class="fu">which.min</span>(ch<span class="sc">$</span>Y),]</span>
<span id="cb17-435"><a href="#cb17-435" aria-hidden="true" tabindex="-1"></a>    gridsize <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">floor</span>(<span class="fu">abs</span>(top_point<span class="sc">$</span>Y<span class="sc">-</span>bottom_point<span class="sc">$</span>Y)<span class="sc">/</span>spacing)<span class="sc">+</span><span class="dv">3</span></span>
<span id="cb17-436"><a href="#cb17-436" aria-hidden="true" tabindex="-1"></a>    rowAngle <span class="ot">&lt;-</span> <span class="fu">tanh</span>((top_point<span class="sc">$</span>X<span class="sc">-</span>bottom_point<span class="sc">$</span>X)<span class="sc">/</span>(top_point<span class="sc">$</span>Y<span class="sc">-</span>bottom_point<span class="sc">$</span>Y))</span>
<span id="cb17-437"><a href="#cb17-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-438"><a href="#cb17-438" aria-hidden="true" tabindex="-1"></a>    cent <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(h) <span class="sc">%&gt;%</span></span>
<span id="cb17-439"><a href="#cb17-439" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bind_cols</span>(<span class="fu">as_tibble</span>(<span class="fu">st_coordinates</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb17-440"><a href="#cb17-440" aria-hidden="true" tabindex="-1"></a>        st_drop_geometry <span class="sc">%&gt;%</span></span>
<span id="cb17-441"><a href="#cb17-441" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(ET_Index, X, Y)</span>
<span id="cb17-442"><a href="#cb17-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-443"><a href="#cb17-443" aria-hidden="true" tabindex="-1"></a>    genRow <span class="ot">&lt;-</span> <span class="cf">function</span>(cX, cY, sp,...){</span>
<span id="cb17-444"><a href="#cb17-444" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(<span class="at">rowid =</span> <span class="fu">seq</span>(<span class="sc">-</span>gridsize,gridsize)) <span class="sc">%&gt;%</span></span>
<span id="cb17-445"><a href="#cb17-445" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">sin</span>(<span class="dv">60</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">180</span><span class="sc">+</span>rowAngle) <span class="sc">*</span>sp<span class="sc">*</span>rowid <span class="sc">+</span> {{cX}},</span>
<span id="cb17-446"><a href="#cb17-446" aria-hidden="true" tabindex="-1"></a>                <span class="at">Y =</span> <span class="fu">cos</span>(<span class="dv">60</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">180</span><span class="sc">+</span>rowAngle) <span class="sc">*</span>sp<span class="sc">*</span>rowid  <span class="sc">+</span> {{cY}})</span>
<span id="cb17-447"><a href="#cb17-447" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-448"><a href="#cb17-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-449"><a href="#cb17-449" aria-hidden="true" tabindex="-1"></a>    centroids <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">crowid=</span><span class="fu">seq</span>(<span class="sc">-</span>gridsize,gridsize)) <span class="sc">%&gt;%</span></span>
<span id="cb17-450"><a href="#cb17-450" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">cY =</span> <span class="fu">cos</span>(rowAngle) <span class="sc">*</span>spacing<span class="sc">*</span>crowid <span class="sc">+</span> cent<span class="sc">$</span>Y,</span>
<span id="cb17-451"><a href="#cb17-451" aria-hidden="true" tabindex="-1"></a>            <span class="co">#spacing/2*crowid + cent$Y,</span></span>
<span id="cb17-452"><a href="#cb17-452" aria-hidden="true" tabindex="-1"></a>            <span class="at">cX =</span>  <span class="fu">sin</span>(rowAngle) <span class="sc">*</span>spacing<span class="sc">*</span>crowid <span class="sc">+</span> cent<span class="sc">$</span>X) <span class="sc">%&gt;%</span></span>
<span id="cb17-453"><a href="#cb17-453" aria-hidden="true" tabindex="-1"></a>        <span class="co">#cent$X + crowid* sqrt(spacing**2-(spacing/2)**2)) %&gt;%</span></span>
<span id="cb17-454"><a href="#cb17-454" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-455"><a href="#cb17-455" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">list</span>(<span class="fu">genRow</span>(<span class="at">cX =</span> cX,<span class="at">cY =</span> cY,<span class="at">sp =</span> spacing))) <span class="sc">%&gt;%</span></span>
<span id="cb17-456"><a href="#cb17-456" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unnest</span>(row) <span class="sc">|&gt;</span></span>
<span id="cb17-457"><a href="#cb17-457" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y) <span class="sc">%&gt;%</span></span>
<span id="cb17-458"><a href="#cb17-458" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="fu">st_crs</span>(h)) <span class="sc">%&gt;%</span></span>
<span id="cb17-459"><a href="#cb17-459" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_filter</span>(h) <span class="sc">%&gt;%</span></span>
<span id="cb17-460"><a href="#cb17-460" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb17-461"><a href="#cb17-461" aria-hidden="true" tabindex="-1"></a>            <span class="at">ET_Index =</span> h<span class="sc">$</span>ET_Index,</span>
<span id="cb17-462"><a href="#cb17-462" aria-hidden="true" tabindex="-1"></a>            <span class="at">ecoregion =</span> h<span class="sc">$</span>ecoregion,</span>
<span id="cb17-463"><a href="#cb17-463" aria-hidden="true" tabindex="-1"></a>            <span class="at">ssuID =</span> <span class="fu">row_number</span>()</span>
<span id="cb17-464"><a href="#cb17-464" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-465"><a href="#cb17-465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(centroids)</span>
<span id="cb17-466"><a href="#cb17-466" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-467"><a href="#cb17-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-468"><a href="#cb17-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-469"><a href="#cb17-469" aria-hidden="true" tabindex="-1"></a>The following step involves defining a function to sample the SSUs within each selected PSU hexagon.</span>
<span id="cb17-470"><a href="#cb17-470" aria-hidden="true" tabindex="-1"></a>SSU sampling is done sequentially, so for each selected SSU, the first and second layers of neighbour points (6 and 12, respectively) are made unavailable for sampling the next SSU.</span>
<span id="cb17-471"><a href="#cb17-471" aria-hidden="true" tabindex="-1"></a>We repeat this process until we reach the total sampling size (<span class="in">`ssu_N`</span>) or when there are no more available SSUs left to sample.</span>
<span id="cb17-472"><a href="#cb17-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-473"><a href="#cb17-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r funSampleSSU,message=FALSE,warning=FALSE,eval=Eval}</span></span>
<span id="cb17-474"><a href="#cb17-474" aria-hidden="true" tabindex="-1"></a>sample_SSU <span class="ot">&lt;-</span> <span class="cf">function</span>(ssuid, prob, geom, filtered, ssuDist, N)</span>
<span id="cb17-475"><a href="#cb17-475" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-476"><a href="#cb17-476" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check if N is even</span></span>
<span id="cb17-477"><a href="#cb17-477" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(N <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb17-478"><a href="#cb17-478" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">'`ssu_N` must be a even number.'</span>)</span>
<span id="cb17-479"><a href="#cb17-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-480"><a href="#cb17-480" aria-hidden="true" tabindex="-1"></a>    filtered_1 <span class="ot">&lt;-</span> filtered</span>
<span id="cb17-481"><a href="#cb17-481" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(filtered))</span>
<span id="cb17-482"><a href="#cb17-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-483"><a href="#cb17-483" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop to sample N SSUs</span></span>
<span id="cb17-484"><a href="#cb17-484" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb17-485"><a href="#cb17-485" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(</span>
<span id="cb17-486"><a href="#cb17-486" aria-hidden="true" tabindex="-1"></a>        count <span class="sc">&lt;=</span> N <span class="sc">&amp;</span></span>
<span id="cb17-487"><a href="#cb17-487" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count))) <span class="sc">&gt;</span> <span class="dv">1</span></span>
<span id="cb17-488"><a href="#cb17-488" aria-hidden="true" tabindex="-1"></a>    ){</span>
<span id="cb17-489"><a href="#cb17-489" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample point</span></span>
<span id="cb17-490"><a href="#cb17-490" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assign</span>(</span>
<span id="cb17-491"><a href="#cb17-491" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'sample_'</span>, count),</span>
<span id="cb17-492"><a href="#cb17-492" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample</span>(</span>
<span id="cb17-493"><a href="#cb17-493" aria-hidden="true" tabindex="-1"></a>                ssuid[<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count))],</span>
<span id="cb17-494"><a href="#cb17-494" aria-hidden="true" tabindex="-1"></a>                <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb17-495"><a href="#cb17-495" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> prob[<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count))]</span>
<span id="cb17-496"><a href="#cb17-496" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-497"><a href="#cb17-497" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-498"><a href="#cb17-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-499"><a href="#cb17-499" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove points around the first sample for second point</span></span>
<span id="cb17-500"><a href="#cb17-500" aria-hidden="true" tabindex="-1"></a>        toKeep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">st_intersects</span>(</span>
<span id="cb17-501"><a href="#cb17-501" aria-hidden="true" tabindex="-1"></a>            geom,</span>
<span id="cb17-502"><a href="#cb17-502" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_buffer</span>(</span>
<span id="cb17-503"><a href="#cb17-503" aria-hidden="true" tabindex="-1"></a>                geom[<span class="fu">which</span>(<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'sample_'</span>, count)) <span class="sc">==</span> ssuid)],</span>
<span id="cb17-504"><a href="#cb17-504" aria-hidden="true" tabindex="-1"></a>                <span class="at">dist =</span> ssuDist <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> ssuDist <span class="sc">*</span> <span class="fl">0.1</span>),</span>
<span id="cb17-505"><a href="#cb17-505" aria-hidden="true" tabindex="-1"></a>                <span class="at">sparse =</span> <span class="cn">FALSE</span></span>
<span id="cb17-506"><a href="#cb17-506" aria-hidden="true" tabindex="-1"></a>        )[, <span class="dv">1</span>]</span>
<span id="cb17-507"><a href="#cb17-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-508"><a href="#cb17-508" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update available points</span></span>
<span id="cb17-509"><a href="#cb17-509" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assign</span>(</span>
<span id="cb17-510"><a href="#cb17-510" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb17-511"><a href="#cb17-511" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'filtered_'</span>, count)) <span class="sc">&amp;</span> toKeep</span>
<span id="cb17-512"><a href="#cb17-512" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-513"><a href="#cb17-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-514"><a href="#cb17-514" aria-hidden="true" tabindex="-1"></a>        <span class="co"># assign point to output vector</span></span>
<span id="cb17-515"><a href="#cb17-515" aria-hidden="true" tabindex="-1"></a>        out[<span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'sample_'</span>, count))] <span class="ot">=</span> count</span>
<span id="cb17-516"><a href="#cb17-516" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-517"><a href="#cb17-517" aria-hidden="true" tabindex="-1"></a>        count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb17-518"><a href="#cb17-518" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-519"><a href="#cb17-519" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>( out )</span>
<span id="cb17-520"><a href="#cb17-520" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-521"><a href="#cb17-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-522"><a href="#cb17-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-523"><a href="#cb17-523" aria-hidden="true" tabindex="-1"></a>With these two functions, we can loop over the <span class="in">`main`</span>, <span class="in">`over`</span>, and <span class="in">`extra`</span> selected hexagons to create and sample SSU points.</span>
<span id="cb17-524"><a href="#cb17-524" aria-hidden="true" tabindex="-1"></a>First, we create the SSU points for all selected hexagons.</span>
<span id="cb17-525"><a href="#cb17-525" aria-hidden="true" tabindex="-1"></a>Then, we generate a buffer around each SSU point with a distance of <span class="in">`ssu_dist/2`</span>.</span>
<span id="cb17-526"><a href="#cb17-526" aria-hidden="true" tabindex="-1"></a>We use the habitat pixels within each buffer to calculate the inclusion probability and the proportion of NA pixels.</span>
<span id="cb17-527"><a href="#cb17-527" aria-hidden="true" tabindex="-1"></a>To save computation time, we compute and store the six neighbour points around each SSU point.</span>
<span id="cb17-528"><a href="#cb17-528" aria-hidden="true" tabindex="-1"></a>Before sampling the SSU points, we classify each point as available or not following these rules:</span>
<span id="cb17-529"><a href="#cb17-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-530"><a href="#cb17-530" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>it must have 6 neighbours (less than that means it's a border SSU)</span>
<span id="cb17-531"><a href="#cb17-531" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>it must have at least 1 - <span class="in">`prop_na`</span> of non-empty pixels</span>
<span id="cb17-532"><a href="#cb17-532" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>4 out of 6 neighbours must also meet these rules</span>
<span id="cb17-533"><a href="#cb17-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-534"><a href="#cb17-534" aria-hidden="true" tabindex="-1"></a>In the final step, we assign a specific code to each selected SSU point and its neighbors, following the <span class="in">`A_B`</span> pattern, where <span class="in">`A`</span> represents the SSU sample ID (ranging from 1 to <span class="in">`ssu_N`</span>), and <span class="in">`B`</span> represents the neighbor ID (ranging from 0 to 6). Here, 0 represents the focal point, and 1 to 6 represent the six neighbors, starting from the top point and moving clockwise.</span>
<span id="cb17-535"><a href="#cb17-535" aria-hidden="true" tabindex="-1"></a>please refer to @sec-ssu for more details.</span>
<span id="cb17-536"><a href="#cb17-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-537"><a href="#cb17-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r SampleSSU,message=FALSE,warning=FALSE,eval=Eval}</span></span>
<span id="cb17-538"><a href="#cb17-538" aria-hidden="true" tabindex="-1"></a><span class="co"># Habitat shapefile to calculate inclusion probability</span></span>
<span id="cb17-539"><a href="#cb17-539" aria-hidden="true" tabindex="-1"></a>land_ca <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'landcover_ca_30m.tif'</span>))</span>
<span id="cb17-540"><a href="#cb17-540" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of habitat types per ecoregion</span></span>
<span id="cb17-541"><a href="#cb17-541" aria-hidden="true" tabindex="-1"></a>prev_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'prev_all.RDS'</span>))</span>
<span id="cb17-542"><a href="#cb17-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-543"><a href="#cb17-543" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb17-544"><a href="#cb17-544" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-545"><a href="#cb17-545" aria-hidden="true" tabindex="-1"></a>    sel_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'selected_'</span>, lyr))</span>
<span id="cb17-546"><a href="#cb17-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-547"><a href="#cb17-547" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate SSU points</span></span>
<span id="cb17-548"><a href="#cb17-548" aria-hidden="true" tabindex="-1"></a>    SSUs <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(</span>
<span id="cb17-549"><a href="#cb17-549" aria-hidden="true" tabindex="-1"></a>        <span class="fu">seq_len</span>(<span class="fu">nrow</span>(sel_lyr)),</span>
<span id="cb17-550"><a href="#cb17-550" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> <span class="fu">genSSU</span>(sel_lyr[.x, ], <span class="at">spacing =</span> ssu_dist)</span>
<span id="cb17-551"><a href="#cb17-551" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-552"><a href="#cb17-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-553"><a href="#cb17-553" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buffer of half `ssu_dist` to compute habitat inclusion prob</span></span>
<span id="cb17-554"><a href="#cb17-554" aria-hidden="true" tabindex="-1"></a>    SSU_bf <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(SSUs, <span class="at">dist =</span> ssu_dist<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb17-555"><a href="#cb17-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-556"><a href="#cb17-556" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract pixels for each SSU polygon</span></span>
<span id="cb17-557"><a href="#cb17-557" aria-hidden="true" tabindex="-1"></a>    hab_pixels <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(</span>
<span id="cb17-558"><a href="#cb17-558" aria-hidden="true" tabindex="-1"></a>        land_ca,</span>
<span id="cb17-559"><a href="#cb17-559" aria-hidden="true" tabindex="-1"></a>        SSU_bf,</span>
<span id="cb17-560"><a href="#cb17-560" aria-hidden="true" tabindex="-1"></a>        <span class="at">progress =</span> <span class="cn">FALSE</span></span>
<span id="cb17-561"><a href="#cb17-561" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-562"><a href="#cb17-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(SSU_bf)</span>
<span id="cb17-563"><a href="#cb17-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-564"><a href="#cb17-564" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get frequence of each class of habitat</span></span>
<span id="cb17-565"><a href="#cb17-565" aria-hidden="true" tabindex="-1"></a>    count_hab <span class="ot">&lt;-</span> <span class="fu">Map</span>(</span>
<span id="cb17-566"><a href="#cb17-566" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(x, y) {</span>
<span id="cb17-567"><a href="#cb17-567" aria-hidden="true" tabindex="-1"></a>                    freq <span class="ot">&lt;-</span> <span class="fu">table</span>(x<span class="sc">$</span>value)</span>
<span id="cb17-568"><a href="#cb17-568" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">length</span>(freq) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb17-569"><a href="#cb17-569" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">data.frame</span>(freq, <span class="at">ecoregion =</span> y)</span>
<span id="cb17-570"><a href="#cb17-570" aria-hidden="true" tabindex="-1"></a>                    }<span class="cf">else</span>{</span>
<span id="cb17-571"><a href="#cb17-571" aria-hidden="true" tabindex="-1"></a>                        <span class="cn">NA</span></span>
<span id="cb17-572"><a href="#cb17-572" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb17-573"><a href="#cb17-573" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb17-574"><a href="#cb17-574" aria-hidden="true" tabindex="-1"></a>                <span class="at">x =</span> hab_pixels,</span>
<span id="cb17-575"><a href="#cb17-575" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> SSUs<span class="sc">$</span>ecoregion</span>
<span id="cb17-576"><a href="#cb17-576" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-577"><a href="#cb17-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-578"><a href="#cb17-578" aria-hidden="true" tabindex="-1"></a>    <span class="co"># merge with inclusion probability</span></span>
<span id="cb17-579"><a href="#cb17-579" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and calculate inclusion probability for each NON empty polygon</span></span>
<span id="cb17-580"><a href="#cb17-580" aria-hidden="true" tabindex="-1"></a>    SSUs<span class="sc">$</span>incl_prob <span class="ot">&lt;-</span> <span class="fu">unlist</span>(</span>
<span id="cb17-581"><a href="#cb17-581" aria-hidden="true" tabindex="-1"></a>            <span class="fu">lapply</span>(</span>
<span id="cb17-582"><a href="#cb17-582" aria-hidden="true" tabindex="-1"></a>                count_hab,</span>
<span id="cb17-583"><a href="#cb17-583" aria-hidden="true" tabindex="-1"></a>                <span class="cf">function</span>(x) {</span>
<span id="cb17-584"><a href="#cb17-584" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>(<span class="fu">is.data.frame</span>(x)) {</span>
<span id="cb17-585"><a href="#cb17-585" aria-hidden="true" tabindex="-1"></a>                        mg_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb17-586"><a href="#cb17-586" aria-hidden="true" tabindex="-1"></a>                            x,</span>
<span id="cb17-587"><a href="#cb17-587" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">subset</span>(</span>
<span id="cb17-588"><a href="#cb17-588" aria-hidden="true" tabindex="-1"></a>                                prev_all, ID_ecoregion <span class="sc">==</span> x<span class="sc">$</span>ecoregion[<span class="dv">1</span>]</span>
<span id="cb17-589"><a href="#cb17-589" aria-hidden="true" tabindex="-1"></a>                            ),</span>
<span id="cb17-590"><a href="#cb17-590" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by.x =</span> <span class="st">"Var1"</span>,</span>
<span id="cb17-591"><a href="#cb17-591" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by.y =</span> <span class="st">"code"</span>,</span>
<span id="cb17-592"><a href="#cb17-592" aria-hidden="true" tabindex="-1"></a>                            <span class="at">all.x =</span> <span class="cn">TRUE</span></span>
<span id="cb17-593"><a href="#cb17-593" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb17-594"><a href="#cb17-594" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">sum</span>(mg_df<span class="sc">$</span>Freq <span class="sc">*</span> mg_df<span class="sc">$</span>incl_prob)</span>
<span id="cb17-595"><a href="#cb17-595" aria-hidden="true" tabindex="-1"></a>                    }<span class="cf">else</span>{</span>
<span id="cb17-596"><a href="#cb17-596" aria-hidden="true" tabindex="-1"></a>                        <span class="cn">NA</span></span>
<span id="cb17-597"><a href="#cb17-597" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb17-598"><a href="#cb17-598" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb17-599"><a href="#cb17-599" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-600"><a href="#cb17-600" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-601"><a href="#cb17-601" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(count_hab)</span>
<span id="cb17-602"><a href="#cb17-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-603"><a href="#cb17-603" aria-hidden="true" tabindex="-1"></a>    SSUs <span class="ot">&lt;-</span> SSUs <span class="sc">|&gt;</span></span>
<span id="cb17-604"><a href="#cb17-604" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(ET_Index) <span class="sc">|&gt;</span></span>
<span id="cb17-605"><a href="#cb17-605" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb17-606"><a href="#cb17-606" aria-hidden="true" tabindex="-1"></a>            <span class="at">incl_prob =</span> incl_prob<span class="sc">/</span><span class="fu">sum</span>(incl_prob, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-607"><a href="#cb17-607" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb17-608"><a href="#cb17-608" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()</span>
<span id="cb17-609"><a href="#cb17-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-610"><a href="#cb17-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-611"><a href="#cb17-611" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate proportion of NA</span></span>
<span id="cb17-612"><a href="#cb17-612" aria-hidden="true" tabindex="-1"></a>    SSUs<span class="sc">$</span>propNA <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb17-613"><a href="#cb17-613" aria-hidden="true" tabindex="-1"></a>        hab_pixels,</span>
<span id="cb17-614"><a href="#cb17-614" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(.x<span class="sc">$</span>value))<span class="sc">/</span><span class="fu">nrow</span>(.x)</span>
<span id="cb17-615"><a href="#cb17-615" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-616"><a href="#cb17-616" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(hab_pixels)</span>
<span id="cb17-617"><a href="#cb17-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-618"><a href="#cb17-618" aria-hidden="true" tabindex="-1"></a>    <span class="co"># neighbours matrix</span></span>
<span id="cb17-619"><a href="#cb17-619" aria-hidden="true" tabindex="-1"></a>    neighbour_ls <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-620"><a href="#cb17-620" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(hx <span class="cf">in</span> <span class="fu">unique</span>(SSUs<span class="sc">$</span>ET_Index))</span>
<span id="cb17-621"><a href="#cb17-621" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb17-622"><a href="#cb17-622" aria-hidden="true" tabindex="-1"></a>        ssuhx <span class="ot">&lt;-</span> <span class="fu">subset</span>(SSUs, ET_Index <span class="sc">==</span> hx)</span>
<span id="cb17-623"><a href="#cb17-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-624"><a href="#cb17-624" aria-hidden="true" tabindex="-1"></a>        neighbour_ls[[hx]] <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(</span>
<span id="cb17-625"><a href="#cb17-625" aria-hidden="true" tabindex="-1"></a>            ssuhx,</span>
<span id="cb17-626"><a href="#cb17-626" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_buffer</span>(ssuhx, <span class="at">dist =</span> ssu_dist <span class="sc">+</span> ssu_dist <span class="sc">*</span> <span class="fl">0.1</span>),</span>
<span id="cb17-627"><a href="#cb17-627" aria-hidden="true" tabindex="-1"></a>            <span class="at">sparse =</span> <span class="cn">FALSE</span></span>
<span id="cb17-628"><a href="#cb17-628" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-629"><a href="#cb17-629" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-630"><a href="#cb17-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-631"><a href="#cb17-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-632"><a href="#cb17-632" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These are the following rules to a SSU be suitable for sampling:</span></span>
<span id="cb17-633"><a href="#cb17-633" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Must have 6 neighbours (less than that means it's a border SSU)</span></span>
<span id="cb17-634"><a href="#cb17-634" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Must have at least 1 - `prop_na` of non empty pixels</span></span>
<span id="cb17-635"><a href="#cb17-635" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - 4 out 6 neighbours must also respect the above rule</span></span>
<span id="cb17-636"><a href="#cb17-636" aria-hidden="true" tabindex="-1"></a>    SSU_selected <span class="ot">=</span> SSUs <span class="sc">|&gt;</span></span>
<span id="cb17-637"><a href="#cb17-637" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(ET_Index) <span class="sc">|&gt;</span></span>
<span id="cb17-638"><a href="#cb17-638" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb17-639"><a href="#cb17-639" aria-hidden="true" tabindex="-1"></a>            <span class="at">nbNeighb =</span> <span class="fu">map_dbl</span>(</span>
<span id="cb17-640"><a href="#cb17-640" aria-hidden="true" tabindex="-1"></a>                ssuID,</span>
<span id="cb17-641"><a href="#cb17-641" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span> <span class="fu">sum</span>(neighbour_ls[[<span class="fu">unique</span>(ET_Index)]][, .x]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb17-642"><a href="#cb17-642" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb17-643"><a href="#cb17-643" aria-hidden="true" tabindex="-1"></a>            <span class="at">nbPropNA =</span> <span class="fu">map_int</span>(</span>
<span id="cb17-644"><a href="#cb17-644" aria-hidden="true" tabindex="-1"></a>                ssuID,</span>
<span id="cb17-645"><a href="#cb17-645" aria-hidden="true" tabindex="-1"></a>                <span class="at">.f =</span> <span class="cf">function</span>(x, pNA, ETI)</span>
<span id="cb17-646"><a href="#cb17-646" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sum</span>(</span>
<span id="cb17-647"><a href="#cb17-647" aria-hidden="true" tabindex="-1"></a>                        pNA[</span>
<span id="cb17-648"><a href="#cb17-648" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">setdiff</span>(<span class="fu">which</span>(neighbour_ls[[ETI]][, x]), x)</span>
<span id="cb17-649"><a href="#cb17-649" aria-hidden="true" tabindex="-1"></a>                        ] <span class="sc">&lt;=</span> prop_na</span>
<span id="cb17-650"><a href="#cb17-650" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb17-651"><a href="#cb17-651" aria-hidden="true" tabindex="-1"></a>                <span class="at">pNA =</span> propNA,</span>
<span id="cb17-652"><a href="#cb17-652" aria-hidden="true" tabindex="-1"></a>                <span class="at">ETI =</span> <span class="fu">unique</span>(ET_Index)</span>
<span id="cb17-653"><a href="#cb17-653" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb17-654"><a href="#cb17-654" aria-hidden="true" tabindex="-1"></a>            <span class="at">sampled =</span> <span class="fu">sample_SSU</span>(</span>
<span id="cb17-655"><a href="#cb17-655" aria-hidden="true" tabindex="-1"></a>                <span class="at">ssuid =</span> ssuID,</span>
<span id="cb17-656"><a href="#cb17-656" aria-hidden="true" tabindex="-1"></a>                <span class="at">prob =</span> incl_prob,</span>
<span id="cb17-657"><a href="#cb17-657" aria-hidden="true" tabindex="-1"></a>                <span class="at">geom =</span> geometry,</span>
<span id="cb17-658"><a href="#cb17-658" aria-hidden="true" tabindex="-1"></a>                <span class="at">filtered =</span> propNA <span class="sc">&lt;=</span> prop_na <span class="sc">&amp;</span> nbNeighb <span class="sc">==</span> <span class="dv">6</span>  <span class="sc">&amp;</span> nbPropNA <span class="sc">&gt;=</span> <span class="dv">4</span>,</span>
<span id="cb17-659"><a href="#cb17-659" aria-hidden="true" tabindex="-1"></a>                <span class="at">ssuDist =</span> ssu_dist,</span>
<span id="cb17-660"><a href="#cb17-660" aria-hidden="true" tabindex="-1"></a>                <span class="at">N =</span> ssu_N</span>
<span id="cb17-661"><a href="#cb17-661" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-662"><a href="#cb17-662" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb17-663"><a href="#cb17-663" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()</span>
<span id="cb17-664"><a href="#cb17-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-665"><a href="#cb17-665" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare selected SSU and their specific neighbours with code like `A_B`</span></span>
<span id="cb17-666"><a href="#cb17-666" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `A` is for the SSU sample ID (1:`ssu_N`)</span></span>
<span id="cb17-667"><a href="#cb17-667" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `B` is for the neighbour ID (0:6 where zero is the focal point, and</span></span>
<span id="cb17-668"><a href="#cb17-668" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1:6 are the 6 neighbours starting from the top point moving clockwise)</span></span>
<span id="cb17-669"><a href="#cb17-669" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="ot">&lt;-</span> <span class="fu">subset</span>(SSU_selected, sampled <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb17-670"><a href="#cb17-670" aria-hidden="true" tabindex="-1"></a>    SSU_lyr_ls <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-671"><a href="#cb17-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-672"><a href="#cb17-672" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SSU_lyr))</span>
<span id="cb17-673"><a href="#cb17-673" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb17-674"><a href="#cb17-674" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get neighbours for specific row</span></span>
<span id="cb17-675"><a href="#cb17-675" aria-hidden="true" tabindex="-1"></a>        nei_hx <span class="ot">&lt;-</span> SSU_selected <span class="sc">|&gt;</span> </span>
<span id="cb17-676"><a href="#cb17-676" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(ET_Index <span class="sc">==</span> SSU_lyr<span class="sc">$</span>ET_Index[i]) <span class="sc">|&gt;</span> </span>
<span id="cb17-677"><a href="#cb17-677" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(</span>
<span id="cb17-678"><a href="#cb17-678" aria-hidden="true" tabindex="-1"></a>                ssuID <span class="sc">%in%</span> <span class="fu">which</span>(</span>
<span id="cb17-679"><a href="#cb17-679" aria-hidden="true" tabindex="-1"></a>                    neighbour_ls[[SSU_lyr<span class="sc">$</span>ET_Index[i]]][, SSU_lyr<span class="sc">$</span>ssuID[i]]</span>
<span id="cb17-680"><a href="#cb17-680" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-681"><a href="#cb17-681" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-682"><a href="#cb17-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-683"><a href="#cb17-683" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code A </span></span>
<span id="cb17-684"><a href="#cb17-684" aria-hidden="true" tabindex="-1"></a>        nei_hx<span class="sc">$</span>codeA <span class="ot">&lt;-</span> SSU_lyr<span class="sc">$</span>sampled[i]</span>
<span id="cb17-685"><a href="#cb17-685" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-686"><a href="#cb17-686" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code B</span></span>
<span id="cb17-687"><a href="#cb17-687" aria-hidden="true" tabindex="-1"></a>        nei_hx<span class="sc">$</span>codeB <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">1</span>)</span>
<span id="cb17-688"><a href="#cb17-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-689"><a href="#cb17-689" aria-hidden="true" tabindex="-1"></a>        SSU_lyr_ls[[i]] <span class="ot">&lt;-</span> nei_hx</span>
<span id="cb17-690"><a href="#cb17-690" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-691"><a href="#cb17-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-692"><a href="#cb17-692" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save</span></span>
<span id="cb17-693"><a href="#cb17-693" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assign</span>(</span>
<span id="cb17-694"><a href="#cb17-694" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">'SSU_all_'</span>, lyr),</span>
<span id="cb17-695"><a href="#cb17-695" aria-hidden="true" tabindex="-1"></a>        SSU_selected</span>
<span id="cb17-696"><a href="#cb17-696" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-697"><a href="#cb17-697" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assign</span>(</span>
<span id="cb17-698"><a href="#cb17-698" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">'SSU_'</span>, lyr),</span>
<span id="cb17-699"><a href="#cb17-699" aria-hidden="true" tabindex="-1"></a>        <span class="fu">do.call</span>(rbind, SSU_lyr_ls)</span>
<span id="cb17-700"><a href="#cb17-700" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-701"><a href="#cb17-701" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-702"><a href="#cb17-702" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-703"><a href="#cb17-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-704"><a href="#cb17-704" aria-hidden="true" tabindex="-1"></a><span class="fu">## Export PSU and SSU samples in shapefiles</span></span>
<span id="cb17-705"><a href="#cb17-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-706"><a href="#cb17-706" aria-hidden="true" tabindex="-1"></a>The purpose of this final section is to export all PSU and SSU points in a shapefile format.</span>
<span id="cb17-707"><a href="#cb17-707" aria-hidden="true" tabindex="-1"></a>The format was chosen to facilitate post-processing, but it can be modified to fit different needs.</span>
<span id="cb17-708"><a href="#cb17-708" aria-hidden="true" tabindex="-1"></a>The first code chunk saves all PSU and SSU points into a single file, while the second code chunk separates the same sampled points by ecoregion.</span>
<span id="cb17-709"><a href="#cb17-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-710"><a href="#cb17-710" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Grouped ecoregions</span></span>
<span id="cb17-711"><a href="#cb17-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-712"><a href="#cb17-712" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=Eval, message=FALSE, warning=FALSE}</span></span>
<span id="cb17-713"><a href="#cb17-713" aria-hidden="true" tabindex="-1"></a>savePath <span class="ot">=</span> <span class="fu">file.path</span>(outputFolder, <span class="st">'allEcoregion'</span>)</span>
<span id="cb17-714"><a href="#cb17-714" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(savePath, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-715"><a href="#cb17-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-716"><a href="#cb17-716" aria-hidden="true" tabindex="-1"></a>varsToRm <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb17-717"><a href="#cb17-717" aria-hidden="true" tabindex="-1"></a>    <span class="st">'OBJECTID'</span>, <span class="st">'Join_Count'</span>, <span class="st">'TARGET_FID'</span>,</span>
<span id="cb17-718"><a href="#cb17-718" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ET_ID'</span>, <span class="st">'ET_ID_Old'</span>, <span class="st">'ET_IDX_Old'</span></span>
<span id="cb17-719"><a href="#cb17-719" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-720"><a href="#cb17-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-721"><a href="#cb17-721" aria-hidden="true" tabindex="-1"></a>hexas_save <span class="ot">&lt;-</span> hexas <span class="sc">|&gt;</span></span>
<span id="cb17-722"><a href="#cb17-722" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">all_of</span>(varsToRm))</span>
<span id="cb17-723"><a href="#cb17-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-724"><a href="#cb17-724" aria-hidden="true" tabindex="-1"></a><span class="co"># rename attributes table so it has a maximum of 10 characters</span></span>
<span id="cb17-725"><a href="#cb17-725" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hexas_save) <span class="ot">&lt;-</span> <span class="fu">abbreviate</span>(<span class="fu">names</span>(hexas_save), <span class="at">minlength =</span> <span class="dv">10</span>)</span>
<span id="cb17-726"><a href="#cb17-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-727"><a href="#cb17-727" aria-hidden="true" tabindex="-1"></a><span class="co"># add coordinates</span></span>
<span id="cb17-728"><a href="#cb17-728" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> hexas_save <span class="sc">|&gt;</span></span>
<span id="cb17-729"><a href="#cb17-729" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_centroid</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-730"><a href="#cb17-730" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-731"><a href="#cb17-731" aria-hidden="true" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-732"><a href="#cb17-732" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>()</span>
<span id="cb17-733"><a href="#cb17-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-734"><a href="#cb17-734" aria-hidden="true" tabindex="-1"></a>hexas_save <span class="ot">&lt;-</span> hexas_save <span class="sc">|&gt;</span></span>
<span id="cb17-735"><a href="#cb17-735" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb17-736"><a href="#cb17-736" aria-hidden="true" tabindex="-1"></a>        <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb17-737"><a href="#cb17-737" aria-hidden="true" tabindex="-1"></a>        <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb17-738"><a href="#cb17-738" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-739"><a href="#cb17-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-740"><a href="#cb17-740" aria-hidden="true" tabindex="-1"></a><span class="co"># save all PSU</span></span>
<span id="cb17-741"><a href="#cb17-741" aria-hidden="true" tabindex="-1"></a>hexas_save <span class="sc">|&gt;</span></span>
<span id="cb17-742"><a href="#cb17-742" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_sf</span>(</span>
<span id="cb17-743"><a href="#cb17-743" aria-hidden="true" tabindex="-1"></a>        <span class="fu">file.path</span>(</span>
<span id="cb17-744"><a href="#cb17-744" aria-hidden="true" tabindex="-1"></a>            savePath,</span>
<span id="cb17-745"><a href="#cb17-745" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">'PSU-SOBQ_ALL-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb17-746"><a href="#cb17-746" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-747"><a href="#cb17-747" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-748"><a href="#cb17-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-749"><a href="#cb17-749" aria-hidden="true" tabindex="-1"></a><span class="co"># Selected PSUs</span></span>
<span id="cb17-750"><a href="#cb17-750" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb17-751"><a href="#cb17-751" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-752"><a href="#cb17-752" aria-hidden="true" tabindex="-1"></a>    hexas_save <span class="sc">|&gt;</span></span>
<span id="cb17-753"><a href="#cb17-753" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb17-754"><a href="#cb17-754" aria-hidden="true" tabindex="-1"></a>            ET_Index <span class="sc">%in%</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'selected_'</span>, lyr))<span class="sc">$</span>ET_Index</span>
<span id="cb17-755"><a href="#cb17-755" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb17-756"><a href="#cb17-756" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb17-757"><a href="#cb17-757" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb17-758"><a href="#cb17-758" aria-hidden="true" tabindex="-1"></a>                savePath,</span>
<span id="cb17-759"><a href="#cb17-759" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'PSU-SOBQ_'</span>, lyr, <span class="st">'-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb17-760"><a href="#cb17-760" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-761"><a href="#cb17-761" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-762"><a href="#cb17-762" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-763"><a href="#cb17-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-764"><a href="#cb17-764" aria-hidden="true" tabindex="-1"></a><span class="co"># Save all SSU</span></span>
<span id="cb17-765"><a href="#cb17-765" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb17-766"><a href="#cb17-766" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-767"><a href="#cb17-767" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSU main</span></span>
<span id="cb17-768"><a href="#cb17-768" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_all_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb17-769"><a href="#cb17-769" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb17-770"><a href="#cb17-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-771"><a href="#cb17-771" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-772"><a href="#cb17-772" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-773"><a href="#cb17-773" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-774"><a href="#cb17-774" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.frame</span>()</span>
<span id="cb17-775"><a href="#cb17-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-776"><a href="#cb17-776" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-777"><a href="#cb17-777" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb17-778"><a href="#cb17-778" aria-hidden="true" tabindex="-1"></a>            <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb17-779"><a href="#cb17-779" aria-hidden="true" tabindex="-1"></a>            <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb17-780"><a href="#cb17-780" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb17-781"><a href="#cb17-781" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb17-782"><a href="#cb17-782" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb17-783"><a href="#cb17-783" aria-hidden="true" tabindex="-1"></a>                savePath,</span>
<span id="cb17-784"><a href="#cb17-784" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'SSU-SOBQ_ALL_'</span>, lyr, <span class="st">'-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb17-785"><a href="#cb17-785" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-786"><a href="#cb17-786" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-787"><a href="#cb17-787" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-788"><a href="#cb17-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-789"><a href="#cb17-789" aria-hidden="true" tabindex="-1"></a><span class="co"># Save selected SSU</span></span>
<span id="cb17-790"><a href="#cb17-790" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb17-791"><a href="#cb17-791" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-792"><a href="#cb17-792" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSU main</span></span>
<span id="cb17-793"><a href="#cb17-793" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb17-794"><a href="#cb17-794" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb17-795"><a href="#cb17-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-796"><a href="#cb17-796" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-797"><a href="#cb17-797" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-798"><a href="#cb17-798" aria-hidden="true" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-799"><a href="#cb17-799" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.frame</span>()</span>
<span id="cb17-800"><a href="#cb17-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-801"><a href="#cb17-801" aria-hidden="true" tabindex="-1"></a>    SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-802"><a href="#cb17-802" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb17-803"><a href="#cb17-803" aria-hidden="true" tabindex="-1"></a>            <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb17-804"><a href="#cb17-804" aria-hidden="true" tabindex="-1"></a>            <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb17-805"><a href="#cb17-805" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb17-806"><a href="#cb17-806" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb17-807"><a href="#cb17-807" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb17-808"><a href="#cb17-808" aria-hidden="true" tabindex="-1"></a>                savePath,</span>
<span id="cb17-809"><a href="#cb17-809" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'SSU-SOBQ_selected_'</span>, lyr, <span class="st">'-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb17-810"><a href="#cb17-810" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-811"><a href="#cb17-811" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-812"><a href="#cb17-812" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-813"><a href="#cb17-813" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb17-814"><a href="#cb17-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-815"><a href="#cb17-815" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Splited ecoregions</span></span>
<span id="cb17-816"><a href="#cb17-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-817"><a href="#cb17-817" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=Eval, message=FALSE, warning=FALSE}</span></span>
<span id="cb17-818"><a href="#cb17-818" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(eco <span class="cf">in</span> eco_sim)</span>
<span id="cb17-819"><a href="#cb17-819" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb17-820"><a href="#cb17-820" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create folder</span></span>
<span id="cb17-821"><a href="#cb17-821" aria-hidden="true" tabindex="-1"></a>    eco_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb17-822"><a href="#cb17-822" aria-hidden="true" tabindex="-1"></a>        outputFolder,</span>
<span id="cb17-823"><a href="#cb17-823" aria-hidden="true" tabindex="-1"></a>        <span class="st">'byEcoregion'</span>,</span>
<span id="cb17-824"><a href="#cb17-824" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(<span class="st">'ecoregion_'</span>, eco)</span>
<span id="cb17-825"><a href="#cb17-825" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-826"><a href="#cb17-826" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(eco_path, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-827"><a href="#cb17-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-828"><a href="#cb17-828" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PSU</span></span>
<span id="cb17-829"><a href="#cb17-829" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################################</span></span>
<span id="cb17-830"><a href="#cb17-830" aria-hidden="true" tabindex="-1"></a>    hexas_save <span class="sc">|&gt;</span></span>
<span id="cb17-831"><a href="#cb17-831" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb17-832"><a href="#cb17-832" aria-hidden="true" tabindex="-1"></a>        <span class="fu">write_sf</span>(</span>
<span id="cb17-833"><a href="#cb17-833" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(</span>
<span id="cb17-834"><a href="#cb17-834" aria-hidden="true" tabindex="-1"></a>                eco_path,</span>
<span id="cb17-835"><a href="#cb17-835" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">'PSU-SOBQ_eco'</span>, eco, <span class="st">'_ALL-'</span>, fileSuffix, <span class="st">'.shp'</span>)</span>
<span id="cb17-836"><a href="#cb17-836" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-837"><a href="#cb17-837" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-838"><a href="#cb17-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-839"><a href="#cb17-839" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb17-840"><a href="#cb17-840" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb17-841"><a href="#cb17-841" aria-hidden="true" tabindex="-1"></a>        hexas_save <span class="sc">|&gt;</span></span>
<span id="cb17-842"><a href="#cb17-842" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(</span>
<span id="cb17-843"><a href="#cb17-843" aria-hidden="true" tabindex="-1"></a>                ET_Index <span class="sc">%in%</span> <span class="fu">subset</span>(</span>
<span id="cb17-844"><a href="#cb17-844" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'selected_'</span>, lyr)),</span>
<span id="cb17-845"><a href="#cb17-845" aria-hidden="true" tabindex="-1"></a>                    ecoregion <span class="sc">==</span> eco</span>
<span id="cb17-846"><a href="#cb17-846" aria-hidden="true" tabindex="-1"></a>                )<span class="sc">$</span>ET_Index</span>
<span id="cb17-847"><a href="#cb17-847" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb17-848"><a href="#cb17-848" aria-hidden="true" tabindex="-1"></a>            <span class="fu">write_sf</span>(</span>
<span id="cb17-849"><a href="#cb17-849" aria-hidden="true" tabindex="-1"></a>                <span class="fu">file.path</span>(</span>
<span id="cb17-850"><a href="#cb17-850" aria-hidden="true" tabindex="-1"></a>                    eco_path,</span>
<span id="cb17-851"><a href="#cb17-851" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(</span>
<span id="cb17-852"><a href="#cb17-852" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'PSU-SOBQ_eco'</span>,</span>
<span id="cb17-853"><a href="#cb17-853" aria-hidden="true" tabindex="-1"></a>                        eco, <span class="st">'_'</span>,</span>
<span id="cb17-854"><a href="#cb17-854" aria-hidden="true" tabindex="-1"></a>                        lyr, <span class="st">'-'</span>,</span>
<span id="cb17-855"><a href="#cb17-855" aria-hidden="true" tabindex="-1"></a>                        fileSuffix,</span>
<span id="cb17-856"><a href="#cb17-856" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'.shp'</span></span>
<span id="cb17-857"><a href="#cb17-857" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb17-858"><a href="#cb17-858" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-859"><a href="#cb17-859" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-860"><a href="#cb17-860" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-861"><a href="#cb17-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-862"><a href="#cb17-862" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SSU</span></span>
<span id="cb17-863"><a href="#cb17-863" aria-hidden="true" tabindex="-1"></a>    <span class="do">###########################################</span></span>
<span id="cb17-864"><a href="#cb17-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-865"><a href="#cb17-865" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save all SSU</span></span>
<span id="cb17-866"><a href="#cb17-866" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb17-867"><a href="#cb17-867" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb17-868"><a href="#cb17-868" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SSU main</span></span>
<span id="cb17-869"><a href="#cb17-869" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_all_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb17-870"><a href="#cb17-870" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb17-871"><a href="#cb17-871" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb17-872"><a href="#cb17-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-873"><a href="#cb17-873" aria-hidden="true" tabindex="-1"></a>        coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-874"><a href="#cb17-874" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-875"><a href="#cb17-875" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-876"><a href="#cb17-876" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.data.frame</span>()</span>
<span id="cb17-877"><a href="#cb17-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-878"><a href="#cb17-878" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-879"><a href="#cb17-879" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb17-880"><a href="#cb17-880" aria-hidden="true" tabindex="-1"></a>                <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb17-881"><a href="#cb17-881" aria-hidden="true" tabindex="-1"></a>                <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb17-882"><a href="#cb17-882" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb17-883"><a href="#cb17-883" aria-hidden="true" tabindex="-1"></a>            <span class="fu">write_sf</span>(</span>
<span id="cb17-884"><a href="#cb17-884" aria-hidden="true" tabindex="-1"></a>                <span class="fu">file.path</span>(</span>
<span id="cb17-885"><a href="#cb17-885" aria-hidden="true" tabindex="-1"></a>                    eco_path,</span>
<span id="cb17-886"><a href="#cb17-886" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(</span>
<span id="cb17-887"><a href="#cb17-887" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'SSU-SOBQ_eco'</span>,</span>
<span id="cb17-888"><a href="#cb17-888" aria-hidden="true" tabindex="-1"></a>                        eco,</span>
<span id="cb17-889"><a href="#cb17-889" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'_ALL_'</span>,</span>
<span id="cb17-890"><a href="#cb17-890" aria-hidden="true" tabindex="-1"></a>                        lyr, <span class="st">'-'</span>,</span>
<span id="cb17-891"><a href="#cb17-891" aria-hidden="true" tabindex="-1"></a>                        fileSuffix,</span>
<span id="cb17-892"><a href="#cb17-892" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'.shp'</span></span>
<span id="cb17-893"><a href="#cb17-893" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb17-894"><a href="#cb17-894" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-895"><a href="#cb17-895" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-896"><a href="#cb17-896" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-897"><a href="#cb17-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-898"><a href="#cb17-898" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save selected SSU</span></span>
<span id="cb17-899"><a href="#cb17-899" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(lyr <span class="cf">in</span> <span class="fu">c</span>(<span class="st">'main'</span>, <span class="st">'over'</span>, <span class="st">'extra'</span>))</span>
<span id="cb17-900"><a href="#cb17-900" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb17-901"><a href="#cb17-901" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SSU main</span></span>
<span id="cb17-902"><a href="#cb17-902" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">'SSU_'</span>, lyr)) <span class="sc">|&gt;</span></span>
<span id="cb17-903"><a href="#cb17-903" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(ecoregion <span class="sc">==</span> eco) <span class="sc">|&gt;</span></span>
<span id="cb17-904"><a href="#cb17-904" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'nbNeighb'</span>, <span class="st">'nbPropNA'</span>, <span class="st">'sampled'</span>))</span>
<span id="cb17-905"><a href="#cb17-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-906"><a href="#cb17-906" aria-hidden="true" tabindex="-1"></a>        coords <span class="ot">&lt;-</span> SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-907"><a href="#cb17-907" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-908"><a href="#cb17-908" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-909"><a href="#cb17-909" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.data.frame</span>()</span>
<span id="cb17-910"><a href="#cb17-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-911"><a href="#cb17-911" aria-hidden="true" tabindex="-1"></a>        SSU_lyr <span class="sc">|&gt;</span></span>
<span id="cb17-912"><a href="#cb17-912" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb17-913"><a href="#cb17-913" aria-hidden="true" tabindex="-1"></a>                <span class="at">latitude =</span> coords<span class="sc">$</span>Y,</span>
<span id="cb17-914"><a href="#cb17-914" aria-hidden="true" tabindex="-1"></a>                <span class="at">longitude =</span> coords<span class="sc">$</span>X</span>
<span id="cb17-915"><a href="#cb17-915" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb17-916"><a href="#cb17-916" aria-hidden="true" tabindex="-1"></a>            <span class="fu">write_sf</span>(</span>
<span id="cb17-917"><a href="#cb17-917" aria-hidden="true" tabindex="-1"></a>                <span class="fu">file.path</span>(</span>
<span id="cb17-918"><a href="#cb17-918" aria-hidden="true" tabindex="-1"></a>                    eco_path,</span>
<span id="cb17-919"><a href="#cb17-919" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(</span>
<span id="cb17-920"><a href="#cb17-920" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'SSU-SOBQ_eco'</span>,</span>
<span id="cb17-921"><a href="#cb17-921" aria-hidden="true" tabindex="-1"></a>                        eco,</span>
<span id="cb17-922"><a href="#cb17-922" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'_selected_'</span>,</span>
<span id="cb17-923"><a href="#cb17-923" aria-hidden="true" tabindex="-1"></a>                        lyr, <span class="st">'-'</span>,</span>
<span id="cb17-924"><a href="#cb17-924" aria-hidden="true" tabindex="-1"></a>                        fileSuffix,</span>
<span id="cb17-925"><a href="#cb17-925" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'.shp'</span></span>
<span id="cb17-926"><a href="#cb17-926" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb17-927"><a href="#cb17-927" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-928"><a href="#cb17-928" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-929"><a href="#cb17-929" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-930"><a href="#cb17-930" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-931"><a href="#cb17-931" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>